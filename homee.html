<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì±M-USD</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-money-bill-wave logo-icon"></i>
                <h1>üá∫üá∏M-USD</h1>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Login/Register Screen -->
        <div id="auth-screen" class="card">
            <h2>Welcome to M-USD</h2>
            <p>Please login or register to continue</p>
            
            <div class="nav-tabs">
                <div class="nav-tab active" id="login-tab">Login</div>
                <div class="nav-tab" id="register-tab">Register</div>
            </div>
            
            <div id="login-form">
                <div class="form-group">
                    <label for="login-phone">Phone Number</label>
                    <input type="tel" id="login-phone" class="form-control" placeholder="07XXXXXXXX">
                </div>
                <div class="form-group">
                    <label for="login-pin">PIN</label>
                    <input type="password" id="login-pin" class="form-control" placeholder="4-digit PIN" maxlength="4">
                </div>
                <button class="btn btn-primary" id="login-btn">Login</button>
            </div>
            
            <div id="register-form" class="hidden">
                <div class="form-group">
                    <label for="register-phone">Phone Number</label>
                    <input type="tel" id="register-phone" class="form-control" placeholder="07XXXXXXXX">
                </div>
                <div class="form-group">
                    <label for="register-pin">Create PIN</label>
                    <input type="password" id="register-pin" class="form-control" placeholder="4-digit PIN" maxlength="4">
                </div>
                <div class="form-group">
                    <label for="confirm-pin">Confirm PIN</label>
                    <input type="password" id="confirm-pin" class="form-control" placeholder="Confirm PIN" maxlength="4">
                </div>
                <button class="btn btn-primary" id="register-btn">Register</button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="hidden">
            <div class="balance-card">
                <p>Your Balance</p>
                <div class="balance-amount" id="user-balance">USD 0.00</div>
                <p id="user-phone"></p>
            </div>
            
            <div class="menu-grid">
                <div class="menu-item" id="deposit-btn">
                    <div class="menu-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div>Deposit</div>
                </div>
                <div class="menu-item" id="send-money-btn">
                    <div class="menu-icon">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <div>Send Money</div>
                </div>
                <div class="menu-item" id="transactions-btn">
                    <div class="menu-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div>Transactions</div>
                </div>
                <div class="menu-item" id="admin-btn">
                    <div class="menu-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div>Admin</div>
                </div>
            </div>
            
            <button class="btn btn-outline" id="logout-btn">Logout</button>
        </div>

        <!-- Deposit Screen -->
        <div id="deposit-screen" class="card hidden">
            <h2>Deposit Method coming soon</h2>
            <div class="form-group">
                <label for="deposit-amount">Enter Amount (USD)</label>
                
            </div>
            <div class="form-group">
                <p>Minimum deposit: $5.00</p>
                <p>Maximum deposit: $10,000.00</p>
            </div>
            <button class="btn btn-primary" id="confirm-deposit">Continue to Payment</button>
            <button class="btn btn-outline" id="back-from-deposit">Back</button>
        </div>

        <!-- Send Money Screen -->
        <div id="send-money-screen" class="card hidden">
            <h2>Send Money</h2>
            <div class="form-group">
                <label for="recipient-phone">Recipient Phone Number</label>
                <input type="tel" id="recipient-phone" class="form-control" placeholder="07XXXXXXXX">
            </div>
            <div class="form-group">
                <label for="send-amount">Amount (USD)</label>
                <input type="number" id="send-amount" class="form-control" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <p>Transaction Fee (1%): <span id="transaction-fee">USD 0.00</span></p>
                <p>Total Deducted: <span id="total-deducted">USD 0.00</span></p>
            </div>
            <button class="btn btn-primary" id="confirm-send">Send Money</button>
            <button class="btn btn-outline" id="back-from-send">Back</button>
        </div>

        <!-- Transactions Screen -->
        <div id="transactions-screen" class="card hidden">
            <h2>Transaction History</h2>
            <div id="transactions-list">
                <!-- Transactions will be populated here -->
            </div>
            <button class="btn btn-outline" id="back-from-transactions">Back</button>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="admin-panel hidden">
            <h2>Admin Panel</h2>
            
            <div class="admin-section">
                <h3>All Users</h3>
                <div id="users-list">
                    <!-- Users will be populated here -->
                </div>
            </div>
            
            <div class="admin-section">
                <h3>All Transactions</h3>
                <div id="admin-transactions-list">
                    <!-- All transactions will be populated here -->
                </div>
            </div>
            
            <button class="btn btn-outline" id="back-from-admin">Back to Dashboard</button>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-screen" class="card hidden">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <div class="footer">
        <p>üá∫üá∏M-USD &copy; 2026 | Transparent‚Ä¢Simple‚Ä¢Honest</p>
    </div>

    <!-- Embedded Payment Gateway Script -->
    <script>
        // Payment Gateway Configuration
        const CONFIG = {
            PAYMENTS: {
                MIN_DEPOSIT: 5,
                MAX_DEPOSIT: 10000
            }
        };

        // Mock blockchain integration
        const blockchain = {
            addFunds: function(phoneNumber, amount) {
                console.log(`Adding ${amount} to ${phoneNumber}`);
                return true;
            }
        };

        class PaymentGateway {
            constructor() {
                this.initialized = false;
                this.pendingTransactions = new Map();
                this.init();
            }

            init() {
                this.initialized = true;
                this.loadPendingTransactions();
                console.log('‚úÖ Payment gateway initialized');
            }

            loadPendingTransactions() {
                try {
                    const pending = localStorage.getItem('pending_payments');
                    if (pending) {
                        this.pendingTransactions = new Map(JSON.parse(pending));
                    }
                } catch (error) {
                    console.error('Failed to load pending transactions:', error);
                }
            }

            savePendingTransactions() {
                try {
                    localStorage.setItem('pending_payments', JSON.stringify(Array.from(this.pendingTransactions.entries())));
                } catch (error) {
                    console.error('Failed to save pending transactions:', error);
                }
            }

            // Show payment methods - FIXED VERSION
            showPaymentMethods(amount) {
                console.log('showPaymentMethods called with amount:', amount);
                
                // Check if user is logged in
                if (!window.app || !window.app.currentUser) {
                    this.showNotification('Please login first', 'error');
                    return false;
                }

                if (!amount || amount <= 0) {
                    this.showNotification('Please enter a valid amount', 'error');
                    return false;
                }

                if (amount < CONFIG.PAYMENTS.MIN_DEPOSIT) {
                    this.showNotification(`Minimum deposit is $${CONFIG.PAYMENTS.MIN_DEPOSIT}`, 'error');
                    return false;
                }

                if (amount > CONFIG.PAYMENTS.MAX_DEPOSIT) {
                    this.showNotification(`Maximum deposit is $${CONFIG.PAYMENTS.MAX_DEPOSIT.toLocaleString()}`, 'error');
                    return false;
                }

                this.createPaymentModal(amount);
                return true;
            }

            // Create payment modal
            createPaymentModal(amount) {
                const modal = document.createElement('div');
                modal.id = 'paymentModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h2>üí≥ Deposit $${amount.toFixed(2)} USD</h2>
                        <p style="text-align: center; margin: 15px 0; color: #666;">
                            Add funds to your M-USD account: <strong>${window.app.currentUser.phone}</strong>
                        </p>
                        
                        <div style="display: grid; gap: 12px; margin: 20px 0;">
                            <button onclick="window.paymentGateway.processCardPayment(${amount})" 
                                    style="background: #635bff; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                                <span>üí≥</span> Credit/Debit Card
                            </button>
                            
                            <button onclick="window.paymentGateway.processPayPal(${amount})" 
                                    style="background: #0070ba; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                                <span>üìä</span> PayPal
                            </button>
                            
                            <button onclick="window.paymentGateway.processBankTransfer(${amount})" 
                                    style="background: #38a169; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                                <span>üè¶</span> Bank Transfer
                            </button>
                            
                            <button onclick="window.paymentGateway.processCrypto(${amount})" 
                                    style="background: #f59e0b; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                                <span>‚Çø</span> Crypto
                            </button>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p style="margin: 0; font-size: 14px; color: #666;">
                                üí∞ <strong>Instant processing</strong> for card and PayPal. Bank transfers take 1-2 business days.
                            </p>
                        </div>
                        
                        <button onclick="window.paymentGateway.closeModal()" 
                                style="background: #718096; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%;">
                            Cancel
                        </button>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            // Process card payment
            async processCardPayment(amount) {
                this.showProcessingModal('Card Payment', amount);
                
                setTimeout(() => {
                    this.closeModal();
                    this.showCardPaymentForm(amount);
                }, 1000);
            }

            // Show card payment form
            showCardPaymentForm(amount) {
                const modal = document.createElement('div');
                modal.id = 'cardPaymentModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10001;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h2>üí≥ Card Payment - $${amount.toFixed(2)}</h2>
                        
                        <div style="margin: 20px 0;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Card Number</label>
                                <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" 
                                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;"
                                       maxlength="19">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Expiry Date</label>
                                    <input type="text" id="expiryDate" placeholder="MM/YY" 
                                           style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;"
                                           maxlength="5">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">CVV</label>
                                    <input type="text" id="cvv" placeholder="123" 
                                           style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;"
                                           maxlength="4">
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Name on Card</label>
                                <input type="text" id="cardName" placeholder="John Doe" 
                                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                            </div>
                        </div>
                        
                        <button onclick="window.paymentGateway.submitCardPayment(${amount})" 
                                style="background: #48bb78; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold;">
                            Pay $${amount.toFixed(2)}
                        </button>
                        
                        <button onclick="window.paymentGateway.closeModal()" 
                                style="background: none; border: none; color: #718096; padding: 10px; cursor: pointer; width: 100%; margin-top: 10px;">
                            ‚Üê Back
                        </button>
                    </div>
                `;

                document.body.appendChild(modal);
                
                // Add input formatting
                const cardNumberInput = document.getElementById('cardNumber');
                if (cardNumberInput) {
                    cardNumberInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                        let matches = value.match(/\d{4,16}/g);
                        let match = matches && matches[0] || '';
                        let parts = [];
                        for (let i = 0; i < match.length; i += 4) {
                            parts.push(match.substring(i, i + 4));
                        }
                        if (parts.length) {
                            e.target.value = parts.join(' ');
                        } else {
                            e.target.value = value;
                        }
                    });
                }

                // Format expiry date input
                const expiryInput = document.getElementById('expiryDate');
                if (expiryInput) {
                    expiryInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length >= 2) {
                            e.target.value = value.substring(0, 2) + '/' + value.substring(2, 4);
                        }
                    });
                }
            }

            // Submit card payment
            async submitCardPayment(amount) {
                const cardNumber = document.getElementById('cardNumber')?.value || '';
                const expiryDate = document.getElementById('expiryDate')?.value || '';
                const cvv = document.getElementById('cvv')?.value || '';
                const cardName = document.getElementById('cardName')?.value || '';

                // Basic validation
                if (!cardNumber || !expiryDate || !cvv || !cardName) {
                    this.showNotification('Please fill all card details', 'error');
                    return;
                }

                this.showProcessingModal('Processing Payment', amount);

                // Simulate payment processing
                setTimeout(() => {
                    this.completePayment(amount, 'credit_card');
                }, 3000);
            }

            // Process PayPal
            async processPayPal(amount) {
                this.showProcessingModal('PayPal', amount);
                
                setTimeout(() => {
                    this.closeModal();
                    this.showPayPalApproval(amount);
                }, 1500);
            }

            // Show PayPal approval
            showPayPalApproval(amount) {
                const modal = document.createElement('div');
                modal.id = 'paypalModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10001;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; text-align: center;">
                        <h2>üìä PayPal Payment</h2>
                        <div style="font-size: 1.5em; margin: 20px 0; color: #0070ba;">
                            $${amount.toFixed(2)} USD
                        </div>
                        <p>You will be redirected to PayPal to complete your payment.</p>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <p style="margin: 0;">Click "Confirm Payment" to simulate successful PayPal payment.</p>
                        </div>
                        
                        <button onclick="window.paymentGateway.completePayment(${amount}, 'paypal')" 
                                style="background: #0070ba; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px;">
                            ‚úÖ Confirm Payment
                        </button>
                        
                        <br>
                        
                        <button onclick="window.paymentGateway.closeModal()" 
                                style="background: #718096; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            // Process bank transfer
            async processBankTransfer(amount) {
                this.closeModal();
                this.showBankDetails(amount);
            }

            // Show bank details
            showBankDetails(amount) {
                const modal = document.createElement('div');
                modal.id = 'bankModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                const reference = `MUSD${window.app.currentUser.phone.replace(/\D/g, '')}${Date.now()}`.substring(0, 16);

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%;">
                        <h2>üè¶ Bank Transfer</h2>
                        <p style="text-align: center; margin-bottom: 20px;">
                            Send <strong>$${amount.toFixed(2)} USD</strong> using the details below:
                        </p>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; font-family: monospace;">
                            <div style="margin-bottom: 10px;"><strong>Bank Name:</strong> M-USD Trust Bank</div>
                            <div style="margin-bottom: 10px;"><strong>Account Name:</strong> M-USD Payments Inc.</div>
                            <div style="margin-bottom: 10px;"><strong>Account Number:</strong> 880123456789</div>
                            <div style="margin-bottom: 10px;"><strong>Routing Number:</strong> 021000021</div>
                            <div style="margin-bottom: 10px;"><strong>SWIFT/BIC:</strong> MUSBUS33</div>
                            <div style="margin-bottom: 10px;"><strong>Reference:</strong> ${reference}</div>
                            <div style="margin-bottom: 10px;"><strong>Amount:</strong> $${amount.toFixed(2)} USD</div>
                        </div>
                        
                        <div style="background: #e6fffa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p style="margin: 0; color: #234e52;">
                                üí° <strong>Important:</strong> Include the reference number exactly as shown above. 
                                Funds will be added to your account within 1-2 business days.
                            </p>
                        </div>
                        
                        <button onclick="window.paymentGateway.recordBankTransfer(${amount}, '${reference}')" 
                                style="background: #38a169; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%;">
                            ‚úÖ I've Sent the Transfer
                        </button>
                        
                        <button onclick="window.paymentGateway.closeModal()" 
                                style="background: #718096; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px;">
                            Close
                        </button>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            // Process crypto
            async processCrypto(amount) {
                this.closeModal();
                this.showCryptoDetails(amount);
            }

            // Show crypto details
            showCryptoDetails(amount) {
                const modal = document.createElement('div');
                modal.id = 'cryptoModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; text-align: center;">
                        <h2>‚Çø Crypto Payment</h2>
                        <p>Send cryptocurrency equivalent to <strong>$${amount.toFixed(2)} USD</strong></p>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <div style="margin-bottom: 15px;">
                                <strong>Bitcoin (BTC):</strong><br>
                                <code style="background: white; padding: 10px; border-radius: 5px; display: inline-block; margin: 5px 0; font-size: 12px;">
                                    bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh
                                </code>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>Ethereum (ETH):</strong><br>
                                <code style="background: white; padding: 10px; border-radius: 5px; display: inline-block; margin: 5px 0; font-size: 12px;">
                                    0x71C7656EC7ab88b098defB751B7401B5f6d8976F
                                </code>
                            </div>
                            <div>
                                <strong>USDT (ERC-20):</strong><br>
                                <code style="background: white; padding: 10px; border-radius: 5px; display: inline-block; margin: 5px 0; font-size: 12px;">
                                    0x71C7656EC7ab88b098defB751B7401B5f6d8976F
                                </code>
                            </div>
                        </div>
                        
                        <p style="color: #666; font-size: 14px;">
                            Funds will be added automatically after 3 network confirmations.
                        </p>
                        
                        <button onclick="window.paymentGateway.recordCryptoPayment(${amount})" 
                                style="background: #f59e0b; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%;">
                            ‚úÖ I've Sent Crypto
                        </button>
                        
                        <button onclick="window.paymentGateway.closeModal()" 
                                style="background: #718096; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px;">
                            Close
                        </button>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            // Complete payment - FIXED VERSION
            completePayment(amount, method) {
                try {
                    if (!window.app || !window.app.currentUser) {
                        throw new Error('User not logged in');
                    }

                    // Use the global callback function
                    if (window.completePaymentGatewayTransaction) {
                        // Close modal first
                        this.closeModal();
                        
                        // Show success message
                        this.showSuccessMessage(amount, method);
                        
                        // Call the main app's completion function
                        setTimeout(() => {
                            window.completePaymentGatewayTransaction(amount, method);
                        }, 2000);
                        
                    } else {
                        throw new Error('Payment system not available');
                    }
                    
                } catch (error) {
                    console.error('Payment error:', error);
                    this.showNotification('Payment failed: ' + error.message, 'error');
                    this.closeModal();
                }
            }

            // Record bank transfer
            recordBankTransfer(amount, reference) {
                this.recordTransaction(amount, 'bank_transfer', 'pending', reference);
                this.closeModal();
                this.showNotification('Bank transfer recorded! We will notify you when funds are available.', 'success');
            }

            // Record crypto payment
            recordCryptoPayment(amount) {
                this.recordTransaction(amount, 'crypto', 'pending');
                this.closeModal();
                this.showNotification('Crypto payment recorded! Funds will be added after confirmation.', 'success');
            }

            // Record transaction
            recordTransaction(amount, method, status, reference = '') {
                const transaction = {
                    id: 'PAY_' + Date.now(),
                    phoneNumber: window.app.currentUser.phone,
                    amount: amount,
                    method: method,
                    status: status,
                    reference: reference,
                    timestamp: new Date().toISOString()
                };
                
                // Store in pending transactions if not completed
                if (status === 'pending') {
                    this.pendingTransactions.set(transaction.id, transaction);
                    this.savePendingTransactions();
                } else {
                    // Remove from pending if completed
                    this.pendingTransactions.delete(transaction.id);
                    this.savePendingTransactions();
                }
                
                // Also save to main transaction history
                const transactions = JSON.parse(localStorage.getItem('payment_transactions') || '[]');
                transactions.push(transaction);
                localStorage.setItem('payment_transactions', JSON.stringify(transactions));
                
                return transaction;
            }

            // Show processing modal
            showProcessingModal(method, amount) {
                const modal = document.createElement('div');
                modal.id = 'processingModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10002;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 15px; max-width: 400px; width: 90%; text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 20px;">‚è≥</div>
                        <h3>Processing ${method} Payment</h3>
                        <p>Please wait while we process your payment of <strong>$${amount.toFixed(2)}</strong></p>
                        <div style="margin: 20px 0;">
                            <div style="height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden;">
                                <div style="height: 100%; background: #48bb78; width: 60%; animation: pulse 1.5s infinite;"></div>
                            </div>
                        </div>
                        <p style="color: #666; font-size: 14px;">Do not close this window...</p>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            // Show success message
            showSuccessMessage(amount, method) {
                const modal = document.createElement('div');
                modal.id = 'successModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10002;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 15px; max-width: 400px; width: 90%; text-align: center;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üéâ</div>
                        <h3 style="color: #38a169;">Payment Successful!</h3>
                        <p>You have successfully deposited <strong>$${amount.toFixed(2)} USD</strong></p>
                        <p style="color: #666; margin: 10px 0;">via ${method.replace('_', ' ').toUpperCase()}</p>
                        
                        <div style="background: #f0fff4; padding: 15px; border-radius: 8px; margin: 20px 0;">
                            <p style="margin: 0; color: #234e52;">
                                üí∞ Funds are now available in your M-USD account
                            </p>
                        </div>
                        
                        <button onclick="window.paymentGateway.closeAllModals()" 
                                style="background: #48bb78; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            Continue
                        </button>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            // Close modal
            closeModal() {
                const modals = ['paymentModal', 'cardPaymentModal', 'paypalModal', 'bankModal', 'cryptoModal', 'processingModal'];
                modals.forEach(id => {
                    const modal = document.getElementById(id);
                    if (modal) modal.remove();
                });
            }

            // Close all modals
            closeAllModals() {
                const modals = document.querySelectorAll('[id$="Modal"]');
                modals.forEach(modal => modal.remove());
            }

            // Show notification
            showNotification(message, type = 'success') {
                if (window.app && window.app.showNotification) {
                    window.app.showNotification(message, type);
                } else {
                    alert(message);
                }
            }
        }

        // Create global instance
        window.paymentGateway = new PaymentGateway();
        console.log('Payment gateway loaded successfully');
    </script>

    <!-- Main App Script -->
    <script type="module">
        // Import Firebase modules for Realtime Database
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, get, push, update, query, orderByChild, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDfP7BSZB7kufh4yrSdpDn14kIdbF9SJdc",
            authDomain: "m-usd-e3555.firebaseapp.com",
            databaseURL: "https://m-usd-e3555-default-rtdb.firebaseio.com",
            projectId: "m-usd-e3555",
            storageBucket: "m-usd-e3555.firebasestorage.app",
            messagingSenderId: "966918203590",
            appId: "1:966918203590:web:b19913384b906a472d0fc7",
            measurementId: "G-Y3X5T8GSNC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Data Storage
        let users = [];
        let transactions = [];
        let currentUser = null;

        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const depositScreen = document.getElementById('deposit-screen');
        const sendMoneyScreen = document.getElementById('send-money-screen');
        const transactionsScreen = document.getElementById('transactions-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loadingScreen = document.getElementById('loading-screen');
        
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        
        const depositBtn = document.getElementById('deposit-btn');
        const sendMoneyBtn = document.getElementById('send-money-btn');
        const transactionsBtn = document.getElementById('transactions-btn');
        const adminBtn = document.getElementById('admin-btn');
        
        const confirmDeposit = document.getElementById('confirm-deposit');
        const backFromDeposit = document.getElementById('back-from-deposit');
        
        const confirmSend = document.getElementById('confirm-send');
        const backFromSend = document.getElementById('back-from-send');
        
        const backFromTransactions = document.getElementById('back-from-transactions');
        const backFromAdmin = document.getElementById('back-from-admin');
        
        const userBalance = document.getElementById('user-balance');
        const userPhone = document.getElementById('user-phone');
        const transactionsList = document.getElementById('transactions-list');
        const usersList = document.getElementById('users-list');
        const adminTransactionsList = document.getElementById('admin-transactions-list');
        
        const sendAmount = document.getElementById('send-amount');
        const recipientPhone = document.getElementById('recipient-phone');
        const transactionFee = document.getElementById('transaction-fee');
        const totalDeducted = document.getElementById('total-deducted');
        
        const notification = document.getElementById('notification');

        // Event Listeners
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        });

        registerTab.addEventListener('click', () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        });

        loginBtn.addEventListener('click', handleLogin);
        registerBtn.addEventListener('click', handleRegister);
        logoutBtn.addEventListener('click', handleLogout);

        depositBtn.addEventListener('click', showDepositScreen);
        sendMoneyBtn.addEventListener('click', showSendMoneyScreen);
        transactionsBtn.addEventListener('click', showTransactionsScreen);
        adminBtn.addEventListener('click', showAdminPanel);

        confirmDeposit.addEventListener('click', handleDeposit);
        backFromDeposit.addEventListener('click', () => showScreen(dashboardScreen));

        confirmSend.addEventListener('click', handleSendMoney);
        backFromSend.addEventListener('click', () => showScreen(dashboardScreen));

        backFromTransactions.addEventListener('click', () => showScreen(dashboardScreen));
        backFromAdmin.addEventListener('click', () => showScreen(dashboardScreen));

        sendAmount.addEventListener('input', updateTransactionDetails);
        recipientPhone.addEventListener('input', updateTransactionDetails);

        // Firebase Realtime Database Functions
        async function loadUsers() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                users = [];
                if (snapshot.exists()) {
                    const usersData = snapshot.val();
                    Object.keys(usersData).forEach(key => {
                        users.push({ id: key, ...usersData[key] });
                    });
                }
                console.log('Loaded users:', users.length);
                return users;
            } catch (error) {
                console.error("Error loading users:", error);
                showNotification('Error loading users', 'error');
                return [];
            }
        }

        async function loadTransactions() {
            try {
                const transactionsRef = ref(database, 'transactions');
                const snapshot = await get(transactionsRef);
                transactions = [];
                if (snapshot.exists()) {
                    const transactionsData = snapshot.val();
                    Object.keys(transactionsData).forEach(key => {
                        transactions.push({ id: key, ...transactionsData[key] });
                    });
                    // Sort by date descending
                    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                }
                console.log('Loaded transactions:', transactions.length);
                return transactions;
            } catch (error) {
                console.error("Error loading transactions:", error);
                showNotification('Error loading transactions', 'error');
                return [];
            }
        }

        async function saveUser(user) {
            try {
                if (user.id) {
                    // Update existing user
                    const userRef = ref(database, 'users/' + user.id);
                    await update(userRef, user);
                } else {
                    // Add new user
                    const usersRef = ref(database, 'users');
                    const newUserRef = push(usersRef);
                    user.id = newUserRef.key;
                    await set(newUserRef, user);
                }
                return user;
            } catch (error) {
                console.error("Error saving user:", error);
                showNotification('Error saving user data', 'error');
                return null;
            }
        }

        async function saveTransaction(transaction) {
            try {
                const transactionsRef = ref(database, 'transactions');
                const newTransactionRef = push(transactionsRef);
                transaction.id = newTransactionRef.key;
                await set(newTransactionRef, transaction);
                return transaction;
            } catch (error) {
                console.error("Error saving transaction:", error);
                showNotification('Error saving transaction', 'error');
                return null;
            }
        }

        // App Functions
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showScreen(screen) {
            authScreen.classList.add('hidden');
            dashboardScreen.classList.add('hidden');
            depositScreen.classList.add('hidden');
            sendMoneyScreen.classList.add('hidden');
            transactionsScreen.classList.add('hidden');
            adminPanel.classList.add('hidden');
            loadingScreen.classList.add('hidden');
            
            screen.classList.remove('hidden');
        }

        function showLoading() {
            authScreen.classList.add('hidden');
            dashboardScreen.classList.add('hidden');
            depositScreen.classList.add('hidden');
            sendMoneyScreen.classList.add('hidden');
            transactionsScreen.classList.add('hidden');
            adminPanel.classList.add('hidden');
            loadingScreen.classList.remove('hidden');
        }

        async function handleLogin() {
            const phone = document.getElementById('login-phone').value;
            const pin = document.getElementById('login-pin').value;
            
            if (!phone || !pin) {
                showNotification('Please enter phone number and PIN', 'error');
                return;
            }
            
            showLoading();
            
            try {
                await loadUsers();
                const user = users.find(u => u.phone === phone && u.pin === pin);
                
                if (!user) {
                    showNotification('Invalid phone number or PIN', 'error');
                    showScreen(authScreen);
                    return;
                }
                
                if (user.isSuspended) {
                    showNotification('Your account has been suspended. Contact support.', 'error');
                    showScreen(authScreen);
                    return;
                }
                
                if (user.isBlocked) {
                    showNotification('Your account has been blocked. Contact support.', 'error');
                    showScreen(authScreen);
                    return;
                }
                
                currentUser = user;
                // Set the global app user for payment gateway
                window.app.setCurrentUser(user);
                updateDashboard();
                showScreen(dashboardScreen);
                showNotification('Login successful!', 'success');
            } catch (error) {
                console.error("Login error:", error);
                showNotification('Login failed. Please try again.', 'error');
                showScreen(authScreen);
            }
        }

        async function handleRegister() {
            const phone = document.getElementById('register-phone').value;
            const pin = document.getElementById('register-pin').value;
            const confirmPin = document.getElementById('confirm-pin').value;
            
            if (!phone || !pin || !confirmPin) {
                showNotification('Please fill all fields', 'error');
                return;
            }
            
            if (pin !== confirmPin) {
                showNotification('PINs do not match', 'error');
                return;
            }
            
            if (pin.length !== 4) {
                showNotification('PIN must be 4 digits', 'error');
                return;
            }
            
            showLoading();
            
            try {
                await loadUsers();
                
                if (users.find(u => u.phone === phone)) {
                    showNotification('Phone number already registered', 'error');
                    showScreen(authScreen);
                    return;
                }
                
                const newUser = {
                    phone,
                    pin,
                    balance: 0,
                    isAdmin: false,
                    isSuspended: false,
                    isBlocked: false,
                    dateCreated: new Date().toISOString()
                };
                
                const savedUser = await saveUser(newUser);
                if (savedUser) {
                    users.push(savedUser);
                    showNotification('Registration successful! Please login.', 'success');
                    loginTab.click();
                    showScreen(authScreen);
                    
                    // Clear form
                    document.getElementById('register-phone').value = '';
                    document.getElementById('register-pin').value = '';
                    document.getElementById('confirm-pin').value = '';
                }
            } catch (error) {
                console.error("Registration error:", error);
                showNotification('Registration failed. Please try again.', 'error');
                showScreen(authScreen);
            }
        }

        function handleLogout() {
            currentUser = null;
            window.app.setCurrentUser(null);
            showScreen(authScreen);
            showNotification('Logged out successfully', 'info');
        }

        function updateDashboard() {
            if (!currentUser) return;
            
            userBalance.textContent = `USD ${currentUser.balance.toFixed(2)}`;
            userPhone.textContent = currentUser.phone;
            
            // Only show admin button for admin users
            adminBtn.style.display = currentUser.isAdmin ? 'block' : 'none';
        }

        function showDepositScreen() {
            showScreen(depositScreen);
            document.getElementById('deposit-amount').value = '';
        }

        async function handleDeposit() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            
            if (amount < 5) {
                showNotification('Minimum deposit is $5.00', 'error');
                return;
            }
            
            if (amount > 10000) {
                showNotification('Maximum deposit is $10,000.00', 'error');
                return;
            }
            
            // Use the payment gateway
            if (window.paymentGateway && window.paymentGateway.showPaymentMethods) {
                console.log('Payment gateway available, showing methods...');
                const success = window.paymentGateway.showPaymentMethods(amount);
                if (!success) {
                    showNotification('Please login first', 'error');
                }
            } else {
                console.log('Payment gateway not available');
                showNotification('Payment gateway not available. Please refresh the page.', 'error');
            }
        }

        // Payment Gateway Integration Function
        window.completePaymentGatewayTransaction = async function(amount, method) {
            showLoading();
            
            try {
                // Update user balance
                currentUser.balance += amount;
                
                // Save updated user
                await saveUser(currentUser);
                
                // Record transaction
                const transaction = {
                    from: 'DEPOSIT',
                    to: currentUser.phone,
                    amount: amount,
                    fee: 0,
                    type: 'deposit',
                    method: method,
                    date: new Date().toISOString()
                };
                
                await saveTransaction(transaction);
                
                // Reload data
                await loadUsers();
                await loadTransactions();
                
                // Update current user reference
                currentUser = users.find(u => u.id === currentUser.id);
                window.app.setCurrentUser(currentUser);
                
                updateDashboard();
                showScreen(dashboardScreen);
                showNotification(`Deposit of USD ${amount.toFixed(2)} successful!`, 'success');
            } catch (error) {
                console.error("Deposit error:", error);
                showNotification('Deposit failed. Please try again.', 'error');
                showScreen(dashboardScreen);
            }
        }

        function showSendMoneyScreen() {
            showScreen(sendMoneyScreen);
            document.getElementById('recipient-phone').value = '';
            document.getElementById('send-amount').value = '';
            updateTransactionDetails();
        }

        function updateTransactionDetails() {
            const amount = parseFloat(sendAmount.value) || 0;
            const fee = amount * 0.01; // 1% transaction fee
            const total = amount + fee;
            
            transactionFee.textContent = `USD ${fee.toFixed(2)}`;
            totalDeducted.textContent = `USD ${total.toFixed(2)}`;
        }

        async function handleSendMoney() {
            const recipient = document.getElementById('recipient-phone').value;
            const amount = parseFloat(document.getElementById('send-amount').value);
            
            if (!recipient || !amount || amount <= 0) {
                showNotification('Please enter valid recipient and amount', 'error');
                return;
            }
            
            if (recipient === currentUser.phone) {
                showNotification('Cannot send money to yourself', 'error');
                return;
            }
            
            showLoading();
            
            try {
                await loadUsers();
                const recipientUser = users.find(u => u.phone === recipient);
                
                if (!recipientUser) {
                    showNotification('Recipient not found', 'error');
                    showScreen(dashboardScreen);
                    return;
                }
                
                if (recipientUser.isSuspended || recipientUser.isBlocked) {
                    showNotification('Recipient account is not active', 'error');
                    showScreen(dashboardScreen);
                    return;
                }
                
                const fee = amount * 0.01; // 1% transaction fee
                const total = amount + fee;
                
                if (currentUser.balance < total) {
                    showNotification('Insufficient balance', 'error');
                    showScreen(dashboardScreen);
                    return;
                }
                
                // Update balances
                currentUser.balance -= total;
                recipientUser.balance += amount;
                
                // Add fee to admin account
                const adminUser = users.find(u => u.isAdmin);
                if (adminUser) {
                    adminUser.balance += fee;
                    await saveUser(adminUser);
                }
                
                // Save updated users
                await saveUser(currentUser);
                await saveUser(recipientUser);
                
                // Record transaction
                const transaction = {
                    from: currentUser.phone,
                    to: recipient,
                    amount: amount,
                    fee: fee,
                    type: 'send',
                    date: new Date().toISOString()
                };
                
                await saveTransaction(transaction);
                
                // Reload data
                await loadUsers();
                await loadTransactions();
                
                // Update current user reference
                currentUser = users.find(u => u.id === currentUser.id);
                window.app.setCurrentUser(currentUser);
                
                updateDashboard();
                showScreen(dashboardScreen);
                showNotification(`Sent USD ${amount.toFixed(2)} to ${recipient}`, 'success');
            } catch (error) {
                console.error("Send money error:", error);
                showNotification('Transaction failed. Please try again.', 'error');
                showScreen(dashboardScreen);
            }
        }

        async function showTransactionsScreen() {
            showScreen(transactionsScreen);
            await displayUserTransactions();
        }

        async function displayUserTransactions() {
            if (!currentUser) return;
            
            await loadTransactions();
            
            const userTransactions = transactions.filter(
                t => t.from === currentUser.phone || t.to === currentUser.phone
            );
            
            transactionsList.innerHTML = '';
            
            if (userTransactions.length === 0) {
                transactionsList.innerHTML = '<p class="no-transactions">No transactions found</p>';
                return;
            }
            
            userTransactions.forEach(transaction => {
                const transactionEl = document.createElement('div');
                transactionEl.className = 'transaction-item';
                
                const isSent = transaction.from === currentUser.phone;
                const amountClass = isSent ? 'transaction-negative' : 'transaction-positive';
                const amountPrefix = isSent ? '-' : '+';
                const typeText = isSent ? 'Sent' : 'Received';
                
                transactionEl.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-type">${typeText} ${isSent ? `to ${transaction.to}` : `from ${transaction.from}`}</div>
                        <div class="transaction-date">${new Date(transaction.date).toLocaleString()}</div>
                        ${transaction.fee > 0 ? `<div class="transaction-fee">Fee: USD ${transaction.fee.toFixed(2)}</div>` : ''}
                        <div class="transaction-method">${transaction.method ? `Method: ${transaction.method}` : ''}</div>
                    </div>
                    <div class="transaction-amount ${amountClass}">
                        ${amountPrefix}USD ${transaction.amount.toFixed(2)}
                    </div>
                `;
                
                transactionsList.appendChild(transactionEl);
            });
        }

        async function showAdminPanel() {
            if (!currentUser || !currentUser.isAdmin) {
                showNotification('Access denied', 'error');
                return;
            }
            
            showScreen(adminPanel);
            await displayAllUsers();
            await displayAllTransactions();
        }

        async function displayAllUsers() {
            await loadUsers();
            usersList.innerHTML = '';
            
            if (users.length === 0) {
                usersList.innerHTML = '<p class="no-users">No users found</p>';
                return;
            }
            
            users.forEach(user => {
                // Skip showing the admin user in the list to avoid self-management
                if (user.isAdmin && user.phone === currentUser.phone) return;
                
                const userEl = document.createElement('div');
                userEl.className = 'user-item';
                
                let statusClass = 'status-active';
                let statusText = 'Active';
                
                if (user.isBlocked) {
                    statusClass = 'status-blocked';
                    statusText = 'Blocked';
                } else if (user.isSuspended) {
                    statusClass = 'status-suspended';
                    statusText = 'Suspended';
                }
                
                userEl.innerHTML = `
                    <div class="user-info">
                        <div class="user-phone"><strong>${user.phone}</strong></div>
                        <div class="user-balance">Balance: USD ${user.balance.toFixed(2)}</div>
                        <div class="user-registered">Registered: ${new Date(user.dateCreated).toLocaleDateString()}</div>
                    </div>
                    <div class="user-controls">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        <div class="user-actions">
                            <button class="action-btn suspend" data-phone="${user.phone}">${user.isSuspended ? 'Activate' : 'Suspend'}</button>
                            <button class="action-btn block" data-phone="${user.phone}">${user.isBlocked ? 'Unblock' : 'Block'}</button>
                            <button class="action-btn recover" data-phone="${user.phone}">Recover Funds</button>
                        </div>
                    </div>
                `;
                
                usersList.appendChild(userEl);
            });
            
            // Add event listeners to action buttons
            setTimeout(() => {
                document.querySelectorAll('.action-btn.suspend').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleSuspendUser(btn.dataset.phone);
                    });
                });
                
                document.querySelectorAll('.action-btn.block').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleBlockUser(btn.dataset.phone);
                    });
                });
                
                document.querySelectorAll('.action-btn.recover').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleRecoverFunds(btn.dataset.phone);
                    });
                });
            }, 100);
        }

        async function displayAllTransactions() {
            await loadTransactions();
            adminTransactionsList.innerHTML = '';
            
            if (transactions.length === 0) {
                adminTransactionsList.innerHTML = '<p class="no-transactions">No transactions found</p>';
                return;
            }
            
            transactions.forEach(transaction => {
                const transactionEl = document.createElement('div');
                transactionEl.className = 'transaction-admin-item';
                
                transactionEl.innerHTML = `
                    <div class="transaction-info">
                        <div class="transaction-parties"><strong>From:</strong> ${transaction.from} <strong>‚Üí To:</strong> ${transaction.to}</div>
                        <div class="transaction-date"><strong>Date:</strong> ${new Date(transaction.date).toLocaleString()}</div>
                        <div class="transaction-type"><strong>Type:</strong> ${transaction.type}</div>
                        ${transaction.method ? `<div class="transaction-method"><strong>Method:</strong> ${transaction.method}</div>` : ''}
                    </div>
                    <div class="transaction-amounts">
                        <div class="transaction-amount"><strong>Amount:</strong> USD ${transaction.amount.toFixed(2)}</div>
                        ${transaction.fee > 0 ? `<div class="transaction-fee"><strong>Fee:</strong> USD ${transaction.fee.toFixed(2)}</div>` : ''}
                    </div>
                `;
                
                adminTransactionsList.appendChild(transactionEl);
            });
        }

        async function handleSuspendUser(phone) {
            const user = users.find(u => u.phone === phone);
            if (user) {
                user.isSuspended = !user.isSuspended;
                user.isBlocked = false; // Can't be both suspended and blocked
                await saveUser(user);
                await displayAllUsers();
                showNotification(`User ${user.isSuspended ? 'suspended' : 'activated'}`, 'info');
            }
        }

        async function handleBlockUser(phone) {
            const user = users.find(u => u.phone === phone);
            if (user) {
                user.isBlocked = !user.isBlocked;
                user.isSuspended = false; // Can't be both suspended and blocked
                await saveUser(user);
                await displayAllUsers();
                showNotification(`User ${user.isBlocked ? 'blocked' : 'activated'}`, 'info');
            }
        }

        async function handleRecoverFunds(phone) {
            const user = users.find(u => u.phone === phone);
            if (user && user.balance > 0) {
                const amount = user.balance;
                
                // Add to admin account
                const adminUser = users.find(u => u.isAdmin);
                if (adminUser) {
                    adminUser.balance += amount;
                    await saveUser(adminUser);
                }
                
                // Record transaction
                const transaction = {
                    from: user.phone,
                    to: 'ADMIN',
                    amount: amount,
                    fee: 0,
                    type: 'recovery',
                    date: new Date().toISOString()
                };
                
                await saveTransaction(transaction);
                
                // Reset user balance
                user.balance = 0;
                await saveUser(user);
                
                await displayAllUsers();
                await displayAllTransactions();
                showNotification(`Recovered USD ${amount.toFixed(2)} from ${user.phone}`, 'success');
            } else {
                showNotification('No funds to recover', 'info');
            }
        }

        // Make the app global for payment gateway access
        window.app = {
            currentUser: null,
            updateDashboard: updateDashboard,
            showNotification: showNotification,
            
            // This will be set when user logs in
            setCurrentUser: function(user) {
                this.currentUser = user;
                currentUser = user; // Also set the local variable
            }
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            showScreen(authScreen);
            
            // Initialize admin account if not exists
            try {
                await loadUsers();
                const adminExists = users.find(u => u.phone === '0700000000');
                
                if (!adminExists) {
                    const adminAccount = {
                        phone: '0700000000',
                        pin: '0000',
                        balance: 0,
                        isAdmin: true,
                        isSuspended: false,
                        isBlocked: false,
                        dateCreated: new Date().toISOString()
                    };
                    
                    await saveUser(adminAccount);
                    users.push(adminAccount);
                    console.log('Admin account created');
                } else {
                    console.log('Admin account already exists');
                }
            } catch (error) {
                console.error("Error initializing admin account:", error);
            }
        });
    </script>

    <style>
        /* Your existing CSS styles remain the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #00a651;
            --secondary: #00a651;
            --dark: #333;
            --light: #f5f5f5;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #3498db;
        }

        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 15px 0;
            text-align: center;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .app-header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            margin: 10px 0;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .hidden {
            display: none;
        }

        .nav-tabs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .balance-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .balance-amount {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-amount {
            font-weight: 600;
        }

        .transaction-positive {
            color: var(--success);
        }

        .transaction-negative {
            color: var(--danger);
        }

        .transaction-fee {
            color: var(--warning);
            font-size: 12px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .menu-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .menu-item:hover {
            transform: translateY(-5px);
        }

        .menu-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .admin-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .admin-section h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .user-item, .transaction-admin-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .action-btn.suspend {
            background-color: var(--warning);
            color: white;
        }

        .action-btn.block {
            background-color: var(--danger);
            color: white;
        }

        .action-btn.recover {
            background-color: var(--info);
            color: white;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background-color: var(--success);
            color: white;
        }

        .status-suspended {
            background-color: var(--warning);
            color: white;
        }

        .status-blocked {
            background-color: var(--danger);
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .notification.info {
            background-color: var(--info);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .logo-icon {
            font-size: 28px;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #777;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-transactions, .no-users {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: white;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-type {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .transaction-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .transaction-fee {
            font-size: 12px;
            color: #f39c12;
        }

        .transaction-method {
            font-size: 12px;
            color: #3498db;
            margin-top: 4px;
        }

        .transaction-amount {
            font-weight: 700;
            font-size: 16px;
        }

        .transaction-positive {
            color: #27ae60;
        }

        .transaction-negative {
            color: #e74c3c;
        }

        /* Admin Panel Styles */
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: white;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-info {
            flex: 1;
        }

        .user-phone {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-balance {
            color: #333;
            margin-bottom: 2px;
        }

        .user-registered {
            font-size: 12px;
            color: #666;
        }

        .user-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .user-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .transaction-admin-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: white;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-parties {
            margin-bottom: 4px;
            font-weight: 500;
        }

        .transaction-amounts {
            text-align: right;
        }

        .admin-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .admin-section h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }
    </style>
</body>
</html>
