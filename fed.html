<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M-USD Chat</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Mobile Web App Capable -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#10b981">
    
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            --primary: #3ACC10;
            --primary-light: #3acc10;
            --primary-dark: #3acc10;
            --secondary: #3acc10;
            --secondary-light: #3acc10;
            --success: #3acc10;
            --success-dark: #3acc10;
            --danger: #ef4444;
            --danger-light: #f87171;
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --light: #f8f9fa;
            --dark: #1a1d29;
            --dark-light: #2d3043;
            --gray: #8a8fa3;
            --gray-light: #e9ecef;
            --border: #e2e8f0;
            --sidebar-bg: #065f46;
            --sidebar-text: #d1fae5;
            --sidebar-active: #34d399;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 40px -15px rgba(0, 0, 0, 0.15);
            --radius: 16px;
            --radius-sm: 10px;
            --radius-lg: 24px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --green-gradient: linear-gradient(135deg, #23DB13 0%, #0EE62B 100%);
            --green-light: #d1fae5;
            --green-dark: #064e3b;
        }

        .dark-theme {
            --light: #1a1d29;
            --dark: #f8f9fa;
            --dark-light: #064e3b;
            --gray-light: #2d3043;
            --border: #2d3043;
            --gray: #8a8fa3;
            --sidebar-bg: #064e3b;
            --sidebar-text: #a7f3d0;
        }

        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.5;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ===== MAIN CONTAINER ===== */
        .app-container {
            width: 100%;
            height: 100vh;
            padding: 0;
            margin: 0;
        }

        .app-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
            background: white;
            overflow: hidden;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.98);
        }

        /* ===== HEADER FOR CHAT ===== */
        .chat-main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--sidebar-bg) 0%, #064e3b 100%);
            padding: 12px 20px;
            z-index: 100;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            font-size: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
            font-family: 'Poppins', sans-serif;
            line-height: 1.2;
        }

        .header-subtitle {
            color: var(--sidebar-text);
            font-size: 11px;
            opacity: 0.8;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .user-name-small {
            font-weight: 600;
            font-size: 13px;
            color: white;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ===== CONTENT AREA ===== */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
            padding-top: 70px;
        }

        .screen {
            display: none;
            height: 100%;
            overflow-y: auto;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-15px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ===== AUTH SCREENS ===== */
        .auth-screen, .welcome-screen, .register-screen {
            padding: 40px 30px;
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius);
            margin: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 500px;
            margin: 40px auto;
            width: 90%;
        }

        .screen-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Poppins', sans-serif;
            line-height: 1.2;
        }

        .screen-description {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 15px;
            line-height: 1.6;
        }

        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--sidebar-text);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            font-size: 15px;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.1);
            color: var(--dark);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            font-family: 'Inter', sans-serif;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .form-control::placeholder {
            color: var(--gray);
            opacity: 0.7;
        }

        /* ===== BUTTON STYLES ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            width: 100%;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.3px;
            font-family: 'Inter', sans-serif;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--green-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: var(--dark-light);
            color: var(--sidebar-text);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: var(--dark-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
            color: white;
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 13px;
            width: auto;
            border-radius: 10px;
            min-width: 80px;
        }

        .btn-icon {
            padding: 10px;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* ===== DASHBOARD ===== */
        .dashboard-screen {
            padding: 0;
            height: 100%;
            width: 100%;
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            background: linear-gradient(135deg, var(--sidebar-bg) 0%, #064e3b 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            padding: 0 15px;
            position: sticky;
            top: 70px;
            z-index: 90;
        }

        .tab {
            flex: 1;
            padding: 16px 0;
            text-align: center;
            font-weight: 600;
            color: var(--sidebar-text);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-size: 13px;
            position: relative;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab:hover {
            color: white;
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            color: white;
            opacity: 1;
            border-bottom-color: var(--primary);
            background: linear-gradient(to bottom, rgba(16, 185, 129, 0.1), transparent);
        }

        .tab i {
            margin-right: 6px;
            font-size: 13px;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.01);
            -webkit-overflow-scrolling: touch;
            background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f9 100%);
        }

        /* ===== SECTION HEADER ===== */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--glass-border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: var(--primary);
            font-size: 14px;
        }

        .section-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* ===== SEARCH BOX ===== */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            padding: 12px 14px 12px 40px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            width: 100%;
            font-size: 14px;
            background: white;
            color: var(--dark);
            transition: var(--transition);
            font-family: 'Inter', sans-serif;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 14px;
        }

        /* ===== GROUP LIST ===== */
        .group-list, .chat-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .group-item, .chat-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .group-item::before, .chat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            opacity: 0;
            transition: var(--transition);
        }

        .group-item:hover, .chat-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .group-item:hover::before, .chat-item:hover::before {
            opacity: 1;
        }

        .group-item.active, .chat-item.active {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.05);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.15);
        }

        .group-item.active::before, .chat-item.active::before {
            opacity: 1;
        }

        .group-header, .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 8px;
        }

        .group-name, .chat-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 15px;
            font-family: 'Poppins', sans-serif;
            line-height: 1.3;
            flex: 1;
            min-width: 0;
        }

        .group-meta, .chat-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--gray);
            flex-wrap: wrap;
        }

        .group-badge, .chat-badge {
            background: var(--green-gradient);
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .group-badge.private, .chat-badge.unread {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
        }

        .group-badge.public {
            background: var(--green-gradient);
        }

        .group-description, .chat-last-message {
            color: var(--gray);
            font-size: 12px;
            margin-top: 6px;
            line-height: 1.4;
            opacity: 0.9;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .chat-last-message.unread {
            color: var(--primary);
            font-weight: 600;
        }

        .group-actions {
            margin-top: 10px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        /* ===== CHAT AREA ===== */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f9 100%);
            position: relative;
            width: 100%;
            height: 100%;
        }

        .chat-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: var(--green-gradient);
            opacity: 0.05;
            pointer-events: none;
        }

        .no-chat-selected {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .no-chat-icon {
            font-size: 64px;
            background: var(--green-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .no-chat-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
            font-family: 'Poppins', sans-serif;
            line-height: 1.2;
        }

        .no-chat-description {
            color: var(--gray);
            max-width: 280px;
            margin-bottom: 25px;
            line-height: 1.5;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 500px;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
            max-width: 140px;
            padding: 10px 14px;
            font-size: 13px;
        }

        /* ===== CHAT HEADER ===== */
        .chat-header {
            padding: 15px;
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            flex-wrap: wrap;
            gap: 10px;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-info h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
            font-family: 'Poppins', sans-serif;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-members {
            font-size: 12px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chat-members i {
            font-size: 11px;
        }

        .chat-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        /* ===== MESSAGES AREA ===== */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: transparent;
            position: relative;
            z-index: 1;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 12px;
            max-width: 75%;
            animation: slideInUp 0.25s ease-out;
            position: relative;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            margin-left: auto;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 20px;
            background: white;
            border: 1px solid var(--border);
            display: inline-block;
            max-width: 100%;
            word-wrap: break-word;
            box-shadow: var(--shadow);
            position: relative;
        }

        .message.sent .message-bubble {
            background: var(--green-gradient);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .message.system .message-bubble {
            background: var(--light);
            color: var(--gray);
            font-style: italic;
            border: 1px dashed var(--border);
            text-align: center;
            margin: 0 auto;
            display: block;
            max-width: 85%;
            font-size: 12px;
            padding: 8px 14px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message.sent .message-sender {
            color: rgba(255, 255, 255, 0.95);
        }

        .message-time {
            font-size: 10px;
            color: var(--gray);
            opacity: 0.8;
        }

        .message.sent .message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .message-content {
            line-height: 1.5;
            font-size: 13px;
            word-break: break-word;
        }

        /* ===== @MENTION STYLES ===== */
        .mention {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 600;
            display: inline;
            margin: 0 2px;
        }

        .mention::before {
            content: '@';
        }

        .message.sent .mention {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* ===== REACTION STYLES ===== */
        .message-reactions {
            display: flex;
            gap: 4px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .reaction-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 3px;
            transition: var(--transition);
            color: var(--gray);
        }

        .reaction-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: white;
        }

        .reaction-btn.active {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--primary);
            color: var(--primary);
        }

        .reaction-count {
            font-weight: 600;
            font-size: 10px;
        }

        .reaction-emoji {
            font-size: 11px;
        }

        /* ===== REPOST STYLES ===== */
        .repost-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: var(--success-dark);
            margin-top: 4px;
        }

        .repost-icon {
            font-size: 9px;
        }

        /* ===== MESSAGE ACTIONS ===== */
        .message-actions {
            display: none;
            position: absolute;
            top: -8px;
            right: 10px;
            background: white;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            z-index: 10;
            padding: 4px;
            gap: 3px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--border);
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            font-size: 11px;
        }

        .message-action-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* ===== QUOTED MESSAGE ===== */
        .quoted-message {
            background: rgba(16, 185, 129, 0.05);
            border-left: 3px solid var(--primary);
            padding: 6px 10px;
            margin-bottom: 6px;
            border-radius: 6px;
            font-size: 12px;
            position: relative;
        }

        .quoted-sender {
            font-weight: 600;
            color: var(--primary);
            font-size: 11px;
            margin-bottom: 2px;
        }

        .quoted-text {
            color: var(--gray);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* ===== PRIVATE CHAT STYLES ===== */
        .private-chat-modal .modal-content {
            max-width: 400px;
        }

        .user-search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
        }

        .user-search-item {
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border);
        }

        .user-search-item:last-child {
            border-bottom: none;
        }

        .user-search-item:hover {
            background: var(--light);
        }

        .user-search-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--green-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 13px;
            flex-shrink: 0;
        }

        .user-search-info {
            flex: 1;
            min-width: 0;
        }

        .user-search-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 13px;
            margin-bottom: 2px;
        }

        .user-search-status {
            font-size: 10px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .user-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .user-status-dot.online {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .user-status-dot.away {
            background: var(--warning);
        }

        .user-status-dot.offline {
            background: var(--gray);
        }

        .private-chat-screen .chat-header {
            background: var(--green-gradient);
            color: white;
        }

        .private-chat-screen .chat-header .chat-info h2 {
            color: white;
        }

        .private-chat-screen .chat-header .chat-members {
            color: rgba(255, 255, 255, 0.8);
        }

        /* ===== CHAT INPUT AREA ===== */
        .chat-input-area {
            padding: 12px 15px;
            background: white;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            z-index: 2;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
            transition: var(--transition);
            background: white;
            line-height: 1.4;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* ===== FILE UPLOAD STYLES ===== */
        .upload-btn {
            padding: 10px;
            background: var(--light);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark);
            transition: var(--transition);
            width: 44px;
            height: 44px;
            flex-shrink: 0;
        }

        .upload-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        .file-preview {
            background: var(--light);
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInDown 0.25s ease;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .file-icon {
            font-size: 24px;
            color: var(--primary);
            flex-shrink: 0;
        }

        .file-details {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 3px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 11px;
            color: var(--gray);
        }

        .file-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .file-download {
            padding: 8px 12px;
            background: var(--light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            text-decoration: none;
            color: var(--dark);
            font-size: 13px;
        }

        .file-download:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 15px;
            animation: fadeIn 0.25s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            font-family: 'Poppins', sans-serif;
            line-height: 1.2;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 22px;
            color: var(--gray);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: var(--light);
            color: var(--danger);
            transform: rotate(90deg);
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 13px;
            font-weight: 500;
        }

        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
            background: var(--green-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
            font-family: 'Poppins', sans-serif;
        }

        .empty-state-description {
            font-size: 13px;
            margin-bottom: 20px;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 12px 15px;
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            font-size: 13px;
            display: none;
            animation: slideDown 0.25s ease;
            border-left: 4px solid transparent;
        }

        .alert.show {
            display: block;
        }

        .alert-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(248, 113, 113, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border-left-color: var(--danger);
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: var(--success);
            border-left-color: var(--success);
        }

        /* ===== NOTIFICATION BADGE ===== */
        .notification-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 700;
            position: absolute;
            top: -4px;
            right: -4px;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
        }

        /* ===== TYPING INDICATOR ===== */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: var(--light);
            border-radius: 18px;
            width: fit-content;
            margin-bottom: 6px;
            align-items: center;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: var(--gray);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-6px);
            }
        }

        .typing-user {
            font-size: 11px;
            color: var(--gray);
            margin-left: 6px;
            white-space: nowrap;
        }

        /* ===== ONLINE USERS ===== */
        .online-users {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .online-user {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 16px;
            font-size: 11px;
            color: var(--primary);
            white-space: nowrap;
        }

        .online-user-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* ===== DATE SEPARATOR ===== */
        .date-separator {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .date-separator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border);
        }

        .date-separator span {
            background: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 10px;
            color: var(--gray);
            position: relative;
            z-index: 1;
            border: 1px solid var(--border);
        }

        /* ===== PROGRESS BAR ===== */
        .progress-bar {
            height: 4px;
            background: var(--light);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .chat-main-header {
                padding: 10px 15px;
                height: 60px;
            }
            
            .header-title {
                font-size: 16px;
            }
            
            .header-subtitle {
                font-size: 10px;
            }
            
            .user-avatar-small {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .user-name-small {
                font-size: 12px;
                max-width: 80px;
            }
            
            .content-area {
                padding-top: 60px;
            }
            
            .tabs {
                top: 60px;
                padding: 0 10px;
            }
            
            .tab {
                padding: 14px 0;
                font-size: 12px;
            }
            
            .tab i {
                margin-right: 4px;
                font-size: 12px;
            }
            
            .tab-content {
                padding: 12px;
            }
            
            .section-title {
                font-size: 15px;
            }
            
            .messages-area {
                padding: 12px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .message-bubble {
                padding: 10px 14px;
                font-size: 12px;
            }
            
            .chat-input-area {
                padding: 10px 12px;
            }
            
            .message-input {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .upload-btn {
                width: 40px;
                height: 40px;
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            .chat-main-header {
                padding: 8px 12px;
                height: 56px;
            }
            
            .header-title {
                font-size: 15px;
            }
            
            .header-logo {
                font-size: 20px;
            }
            
            .content-area {
                padding-top: 56px;
            }
            
            .tabs {
                top: 56px;
            }
            
            .tab {
                padding: 12px 0;
                font-size: 11px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .btn-sm {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .action-buttons .btn {
                min-width: 100px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-6px);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            }
            50% {
                box-shadow: 0 0 25px rgba(16, 185, 129, 0.5);
            }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        .glowing {
            animation: glow 2s ease-in-out infinite;
        }

        /* ===== UTILITY CLASSES ===== */
        .text-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .flex-1 {
            flex: 1;
        }

        .flex-shrink-0 {
            flex-shrink: 0;
        }

        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        /* ===== SAFARI SPECIFIC FIXES ===== */
        @supports (-webkit-touch-callout: none) {
            .app-wrapper {
                height: -webkit-fill-available;
            }
            
            .app-container {
                height: -webkit-fill-available;
            }
            
            .messages-area {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>

    <!-- Main Header -->
    <div class="chat-main-header" id="mainHeader">
        <div class="header-left">
            <div class="header-logo">
                <i class="fas fa-comments"></i>
            </div>
            <div>
                <div class="header-title">M-USD Chat</div>
                <div class="header-subtitle" id="headerSubtitle">Professional Chat System</div>
            </div>
        </div>
        <div class="header-user" id="headerUser" style="display: none;">

            <div class="user-avatar-small" id="headerUserAvatar">
                <img id="headerUserAvatarImg" src="" alt="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
                <span id="headerUserInitial">U</span>
            </div>
            <div class="user-name-small" id="headerUserName">User</div>

            <button class="btn btn-sm btn-danger" onclick="signOut()" title="Sign Out">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <div class="app-wrapper">
            <!-- Main Content Area -->
            <div class="content-area">
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="screen active">
                    <div class="welcome-screen">
                        <div class="screen-title">Welcome to M-USD Chat</div>
                        <p class="screen-description">
                            Connect with friends and colleagues in real-time. Join existing groups or create your own.
                        </p>
                        <div class="form-group">
                            <button class="btn btn-primary floating" onclick="showScreen('authScreen')">
                                <i class="fas fa-sign-in-alt"></i> Sign In
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Auth Screen -->
                <div id="authScreen" class="screen">
                    <div class="auth-screen">
                        <div class="screen-title">Welcome Back</div>
                        <p class="screen-description">
                            Sign in to your account to continue chatting
                        </p>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="email" class="form-control" placeholder="you@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <div style="position: relative;">
                                <input type="password" id="password" class="form-control" placeholder="">
                                <button onclick="togglePassword()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray); cursor: pointer; padding: 8px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="signIn()">
                                <i class="fas fa-sign-in-alt"></i> Sign In
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="signUp()">
                                <i class="fas fa-user-plus"></i> Create Account
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-outline" onclick="showScreen('welcomeScreen')">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Registration Screen -->
                <div id="registrationScreen" class="screen">
                    <div class="register-screen">
                        <div class="screen-title">Complete Your Profile</div>
                        <p class="screen-description">
                            Choose a username that will be visible to other users
                        </p>
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" id="username" class="form-control" placeholder="Enter username (3-30 characters)" maxlength="30">
                            <div style="font-size: 12px; color: var(--gray); margin-top: 5px;">This will be your display name</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Profile Picture (Optional)</label>
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <div id="profilePreview" style="width: 70px; height: 70px; border-radius: 50%; background: var(--green-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 22px; overflow: hidden; flex-shrink: 0;">
                                    <img id="profileImage" src="" alt="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span id="profileInitial">U</span>
                                </div>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="document.getElementById('profileUpload').click()">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <input type="file" id="profileUpload" accept="image/*" style="display: none;" onchange="handleProfileUpload(event)">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary glowing" onclick="completeRegistration()">
                                <i class="fas fa-check"></i> Complete Registration
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Screen -->
                <div id="dashboardScreen" class="screen">
                    <!-- Tabs -->
                    <div class="tabs">
                        <div class="tab active" onclick="showTab('myGroupsTab')">
                            <i class="fas fa-users"></i> <span class="tab-text">My Groups</span>
                        </div>
                        <div class="tab" onclick="showTab('publicGroupsTab')">
                            <i class="fas fa-globe"></i> <span class="tab-text">Public</span>
                        </div>
                        <div class="tab" onclick="showTab('globalChatTab')">
                            <i class="fas fa-comments"></i> <span class="tab-text">Global</span>
                        </div>
                        <div class="tab" onclick="showTab('privateChatsTab')" id="privateTab">
                            <i class="fas fa-user-lock"></i> <span class="tab-text">Private Chats</span>
                            <span class="notification-badge" id="privateNotificationBadge" style="display: none;">0</span>
                        </div>
                    </div>

                    <!-- Tab Contents -->
                    <div class="tab-content">
                        <!-- My Groups Tab -->
                        <div id="myGroupsTab" class="tab-pane active">
                            <div class="section-header">
                                <div class="section-title">
                                    <i class="fas fa-users"></i> My Groups
                                </div>
                                <div class="section-actions">
         </div>
                            </div>
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" id="searchMyGroups" placeholder="Search my groups..." oninput="searchMyGroups()">
                            </div>
                            
                                                               <button class="btn btn-sm btn-primary glowing" onclick="showCreateGroupModal()">
                                        <i class="fas fa-plus"></i> New Group
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="searchAndJoinGroup()">
                                        <i class="fas fa-search"></i> Search Groups
                                    </button>
                        
                            
                            
                            <div id="groupsList" class="group-list">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <div class="empty-state-title">No Groups Yet</div>
                                    <p class="empty-state-description">You haven't joined any groups. Create or join one to get started!</p>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-primary" onclick="showCreateGroupModal()">
                                            <i class="fas fa-plus"></i> Create Group
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="searchAndJoinGroup()">
                                            <i class="fas fa-search"></i> Search Groups
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Public Groups Tab -->
                        <div id="publicGroupsTab" class="tab-pane" style="display: none;">
                            <div class="section-header">
                                <div class="section-title">
                                    <i class="fas fa-globe"></i> Public Groups
                                </div>
                                <div class="section-actions">
        </div>
                            </div>
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" id="searchPublicGroups" placeholder="Search public groups..." oninput="searchPublicGroups()">
                            </div>
                            
                            
                            
                                                                <button class="btn btn-sm btn-success" onclick="searchAndJoinGroup()">
                                        <i class="fas fa-search"></i> Search All
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="refreshPublicGroups()" title="Refresh">
                                        <i class="fas fa-sync"></i>
                                    </button>
                        
                            
                            
                            
                            
                            <div id="publicGroupsList" class="group-list">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <div class="loading-text">Loading public groups...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Global Chat Tab -->
                        <div id="globalChatTab" class="tab-pane" style="display: none;">
                            <div class="section-header">
                                <div class="section-title">
                                    <i class="fas fa-comments"></i> Global Chat
                                </div>
          </div>
                            <div id="globalOnlineUsers" class="online-users">
                                <!-- Online users will be populated here -->
                            </div>
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <div class="empty-state-title">Global Chat Room</div>
                                <p class="empty-state-description">Connect with everyone in the global chat room. Join to start chatting!</p>
                                <button class="btn btn-primary" onclick="joinGlobalChat()">
                                    <i class="fas fa-globe"></i> Join Global Chat
                                </button>
                            </div>
                        </div>

                        <!-- Private Chats Tab -->
                        <div id="privateChatsTab" class="tab-pane" style="display: none;">
                            <div class="section-header">
                                <div class="section-title">
                                    <i class="fas fa-user-lock"></i> Private Chats
                                </div>
                                <div class="section-actions">
           </div>
                            </div>
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" id="searchPrivateChats" placeholder="Search private chats..." oninput="searchPrivateChats()">
                            </div>
                            
                            
                            
                            
                                    <button class="btn btn-sm btn-primary glowing" onclick="showPrivateChatModal()">
                                        <i class="fas fa-user-plus"></i> New Chat
                                    </button>
                     




                            <div id="privateChatsList" class="chat-list">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <div class="empty-state-title">No Private Chats</div>
                                    <p class="empty-state-description">Start a private conversation with another user.</p>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-primary" onclick="showPrivateChatModal()">
                                            <i class="fas fa-user-plus"></i> New Private Chat
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Group Chat Screen -->
                <div id="groupChatScreen" class="screen">
                    <div class="chat-header">
                        <div class="chat-info">
                            <h2 id="chatGroupName">Group Name</h2>
                            <div class="chat-members">
                                <i class="fas fa-users"></i>
                                <span id="chatMemberCount">0 members</span>
                                <span style="margin: 0 6px;"></span>
                                <i class="fas fa-clock"></i>
                                <span id="lastSeen">Just now</span>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="btn btn-sm btn-secondary" onclick="showGroupInfoModal()" title="Group Info">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="showGroupMembersModal()" title="Members">
                                <i class="fas fa-user-friends"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="leaveGroupConfirm()" title="Leave Group">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="showScreen('dashboardScreen')" title="Back to Groups">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <div id="groupChatMessages" class="messages-area">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">No Messages Yet</div>
                            <p class="empty-state-description">Send the first message to start the conversation!</p>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <div id="typingIndicator" class="typing-indicator" style="display: none;">
                            <span></span>
                            <span></span>
                            <span></span>
                            <span class="typing-user" id="typingUser"></span>
                        </div>
                        <div id="groupFilePreviewArea" style="display: none;"></div>
                        <div class="input-wrapper">
                            <input type="file" id="groupFileInput" style="display: none;" onchange="handleFileSelect(event, 'group')" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt">
                            <button class="btn btn-icon upload-btn" onclick="openFilePicker('group')" title="Attach file">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <textarea class="message-input" id="groupMessageInput" placeholder="Type your message here..." rows="1" oninput="handleTyping('group')"></textarea>
                            <button class="btn btn-primary btn-icon glowing" onclick="sendGroupMessage()" title="Send">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Global Chat Screen -->
                <div id="globalChatScreen" class="screen">
                    <div class="chat-header">
                        <div class="chat-info">
                            <h2><i class="fas fa-globe"></i> Global Chat</h2>
                            <div class="chat-members">
                                <i class="fas fa-users"></i>
                                <span id="globalUserCount">0 users online</span>
                                <span style="margin: 0 6px;"></span>
                                <span id="globalChatStatus" style="color: #10b981;">
                                    <i class="fas fa-circle"></i> Live
                                </span>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="btn btn-sm btn-secondary" onclick="showGlobalChatInfo()" title="Info">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="leaveGlobalChat()" title="Leave Chat">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="showScreen('dashboardScreen')" title="Back to Groups">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <div id="globalChatMessages" class="messages-area">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">Global Chat Room</div>
                            <p class="empty-state-description">Welcome to the global chat! Be respectful and follow community guidelines.</p>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <div id="globalTypingIndicator" class="typing-indicator" style="display: none;">
                            <span></span>
                            <span></span>
                            <span></span>
                            <span class="typing-user" id="globalTypingUser"></span>
                        </div>
                        <div id="globalFilePreviewArea" style="display: none;"></div>
                        <div class="input-wrapper">
                            <input type="file" id="globalFileInput" style="display: none;" onchange="handleFileSelect(event, 'global')" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt">
                            <button class="btn btn-icon upload-btn" onclick="openFilePicker('global')" title="Attach file">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <textarea class="message-input" id="globalMessageInput" placeholder="Type your message to everyone..." rows="1" oninput="handleTyping('global')"></textarea>
                            <button class="btn btn-primary btn-icon glowing" onclick="sendGlobalMessage()" title="Send">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Private Chat Screen -->
                <div id="privateChatScreen" class="screen private-chat-screen">
                    <div class="chat-header">
                        <div class="chat-info">
                            <h2 id="privateChatUserName">Private Chat</h2>
                            <div class="chat-members">
                                <i class="fas fa-user"></i>
                                <span id="privateChatStatus">Online</span>
                                <span style="margin: 0 6px;"></span>
                                <i class="fas fa-lock"></i>
                                <span>Private</span>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="btn btn-sm btn-secondary" onclick="showPrivateChatInfo()" title="User Info">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="endPrivateChat()" title="End Chat">
                                <i class="fas fa-times"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="showScreen('dashboardScreen')" title="Back">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <div id="privateChatMessages" class="messages-area">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">Private Chat</div>
                            <p class="empty-state-description">Your messages are end-to-end encrypted. Start a conversation!</p>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <div id="privateTypingIndicator" class="typing-indicator" style="display: none;">
                            <span></span>
                            <span></span>
                            <span></span>
                            <span class="typing-user" id="privateTypingUser"></span>
                        </div>
                        <div id="privateFilePreviewArea" style="display: none;"></div>
                        <div class="input-wrapper">
                            <input type="file" id="privateFileInput" style="display: none;" 
                                   onchange="handleFileSelect(event, 'private')" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt">
                            <button class="btn btn-icon upload-btn" onclick="openFilePicker('private')" title="Attach file">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <textarea class="message-input" id="privateMessageInput" 
                                      placeholder="Type your private message..." rows="1" 
                                      oninput="handleTyping('private')"></textarea>
                            <button class="btn btn-primary btn-icon glowing" onclick="sendPrivateMessage()" title="Send">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Group</div>
                <button class="modal-close" onclick="hideCreateGroupModal()"></button>
            </div>
            <div class="form-group">
                <label class="form-label">Group Name</label>
                <input type="text" id="groupName" class="form-control" placeholder="Enter group name" maxlength="50">
            </div>
            <div class="form-group">
                <label class="form-label">Description (Optional)</label>
                <textarea id="groupDescription" class="form-control" placeholder="Describe your group..." rows="3" maxlength="200"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Group Type</label>
                <select id="groupType" class="form-control">
                    <option value="public">Public - Anyone can join</option>
                    <option value="private">Private - Invite only</option>
                </select>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="createGroup()">
                    <i class="fas fa-plus"></i> Create Group
                </button>
            </div>
        </div>
    </div>

    <!-- Join Group Modal -->
    <div id="joinGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Join a Group</div>
                <button class="modal-close" onclick="hideJoinGroupModal()"></button>
            </div>
            <div class="form-group">
                <label class="form-label">Group ID</label>
                <input type="text" id="joinGroupId" class="form-control" placeholder="Enter group ID (e.g., abc123)" maxlength="20">
            </div>
            <p style="color: var(--gray); font-size: 13px; margin-bottom: 20px;">
                Ask the group owner for the Group ID, or browse public groups to find one to join.
            </p>
            <div class="form-group">
                <button class="btn btn-primary" onclick="joinGroup()">
                    <i class="fas fa-sign-in-alt"></i> Join Group
                </button>
            </div>
            <div class="form-group">
                <button class="btn btn-secondary" onclick="showTab('publicGroupsTab'); hideJoinGroupModal();">
                    <i class="fas fa-search"></i> Browse Public Groups
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="modal-close" onclick="hideSettingsModal()"></button>
            </div>
            <div class="form-group">
                <label class="form-label">Theme</label>
                <select id="themeSelect" class="form-control" onchange="changeTheme(this.value)">
                    <option value="light">Light Theme</option>
                    <option value="dark">Dark Theme</option>
                    <option value="auto">Auto (System)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Notification Sound</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="notificationSound" checked>
                    <label for="notificationSound" style="font-size: 14px;">Play sound on new message</label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Message Preview</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="messagePreview" checked>
                    <label for="messagePreview" style="font-size: 14px;">Show message preview in notifications</label>
                </div>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Private Chat Modal -->
    <div id="privateChatModal" class="modal private-chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Start Private Chat</div>
                <button class="modal-close" onclick="hidePrivateChatModal()"></button>
            </div>
            <div class="form-group">
                <label class="form-label">Search User by Username</label>
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="userSearchInput" 
                           placeholder="Type username..." 
                           oninput="searchUsers(this.value)">
                </div>
                <div id="userSearchResults" class="user-search-results" style="display: none;">
                    <!-- User results will be populated here -->
                </div>
            </div>
            <p style="color: var(--gray); font-size: 13px; margin-bottom: 20px;">
                Search for a user by their username to start a private conversation.
            </p>
        </div>
    </div>

    <!-- Firebase & App Script -->
    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDfP7BSZB7kufh4yrSdpDn14kIdbF9SJdc",
            authDomain: "m-usd-e3555.firebaseapp.com",
            databaseURL: "https://m-usd-e3555-default-rtdb.firebaseio.com",
            projectId: "m-usd-e3555",
            storageBucket: "m-usd-e3555.firebasestorage.app",
            messagingSenderId: "966918203590",
            appId: "1:966918203590:web:b19913384b906a472d0fc7",
            measurementId: "G-Y3X5T8GSNC"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ==================== APP STATE ====================
        let currentUser = null;
        let userProfile = null;
        let currentGroup = null;
        let currentGroupType = null;
        let privateChatUser = null;
        let currentPrivateChatId = null;
        let messagesListener = null;
        let globalChatListener = null;
        let privateChatListener = null;
        let typingListener = null;
        let onlineUsersListener = null;
        let privateChatsListener = null;
        
        // File upload state
        let selectedFiles = [];
        let currentChatType = '';
        let profileImageFile = null;
        
        // Cache for public groups
        window.publicGroupsCache = [];
        
        // Typing state
        let typingTimeout = null;
        let lastTypingSent = 0;
        
        // Settings
        let settings = {
            theme: 'light',
            notificationSound: true,
            messagePreview: true
        };

        // Notification state
        let privateMessagesListener = null;
        let unreadPrivateCount = 0;
        let originalTitle = document.title;
        let notificationInterval = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('M-USD Chat initialized');
            
            // Load settings
            loadSettings();
            
            // Request notification permission
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
            
            // Initialize app
            showScreen('welcomeScreen');
            initializeGlobalChat();
            
            // Auto-resize textareas
            const textareas = document.querySelectorAll('.message-input');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            });
            
            // Handle Enter key for sending messages
            document.getElementById('groupMessageInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendGroupMessage();
                }
            });
            
            document.getElementById('globalMessageInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendGlobalMessage();
                }
            });
            
            document.getElementById('privateMessageInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPrivateMessage();
                }
            });
            
            // Close modals on outside click
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // Check for authentication state
            auth.onAuthStateChanged(handleAuthStateChange);
            
            // Handle tab visibility for online status
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && currentUser) {
                    updateUserStatus('away');
                } else if (currentUser) {
                    updateUserStatus('online');
                }
            });
        });

        // ==================== THEME FUNCTIONS ====================
        function toggleTheme() {
            const body = document.body;
            const themeBtn = document.querySelector('.theme-btn i');
            
            if (body.classList.contains('dark-theme')) {
                body.classList.remove('dark-theme');
                themeBtn.className = 'fas fa-moon';
                settings.theme = 'light';
            } else {
                body.classList.add('dark-theme');
                themeBtn.className = 'fas fa-sun';
                settings.theme = 'dark';
            }
            
            saveSettings();
        }

        function loadSettings() {
            const saved = localStorage.getItem('chatSettings');
            if (saved) {
                settings = JSON.parse(saved);
                
                // Apply theme
                if (settings.theme === 'dark') {
                    document.body.classList.add('dark-theme');
                } else if (settings.theme === 'auto') {
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.body.classList.add('dark-theme');
                    }
                }
                
                // Apply other settings
                document.getElementById('themeSelect').value = settings.theme;
                document.getElementById('notificationSound').checked = settings.notificationSound;
                document.getElementById('messagePreview').checked = settings.messagePreview;
            }
        }

        function saveSettings() {
            settings.theme = document.getElementById('themeSelect').value;
            settings.notificationSound = document.getElementById('notificationSound').checked;
            settings.messagePreview = document.getElementById('messagePreview').checked;
            
            localStorage.setItem('chatSettings', JSON.stringify(settings));
            
            // Apply theme if changed
            if (settings.theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else if (settings.theme === 'light') {
                document.body.classList.remove('dark-theme');
            } else if (settings.theme === 'auto') {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
            }
            
            hideSettingsModal();
            showAlert('Settings saved successfully!', 'success');
        }

        function changeTheme(theme) {
            settings.theme = theme;
            document.getElementById('themeSelect').value = theme;
        }

        // ==================== UI FUNCTIONS ====================
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.content-area .screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show target screen
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.add('active');
                updateHeaderForScreen(screenId);
            }
        }

        function updateHeaderForScreen(screenId) {
            const headerUser = document.getElementById('headerUser');
            const headerSubtitle = document.getElementById('headerSubtitle');
            
            if (screenId === 'welcomeScreen' || screenId === 'authScreen' || screenId === 'registrationScreen') {
                headerUser.style.display = 'none';
                headerSubtitle.textContent = 'Professional Chat System';
            } else if (screenId === 'dashboardScreen') {
                headerUser.style.display = 'flex';
                headerSubtitle.textContent = 'Dashboard';
            } else if (screenId === 'groupChatScreen') {
                headerUser.style.display = 'flex';
                headerSubtitle.textContent = 'Group Chat';
            } else if (screenId === 'globalChatScreen') {
                headerUser.style.display = 'flex';
                headerSubtitle.textContent = 'Global Chat';
            } else if (screenId === 'privateChatScreen') {
                headerUser.style.display = 'flex';
                headerSubtitle.textContent = 'Private Chat';
            }
        }

        function showTab(tabId) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate clicked tab
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes(tabId.replace('Tab', ''))) {
                    tab.classList.add('active');
                }
            });
            
            // Show tab content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.style.display = 'none';
            });
            
            const pane = document.getElementById(tabId);
            if (pane) {
                pane.style.display = 'block';
            }
            
            // Load content if needed
            if (tabId === 'publicGroupsTab') {
                loadPublicGroups();
            } else if (tabId === 'globalChatTab') {
                loadOnlineUsers();
            } else if (tabId === 'myGroupsTab') {
                loadUserGroups();
            } else if (tabId === 'privateChatsTab') {
                loadPrivateChats();
            }
        }

        function showAlert(message, type = 'error', duration = 4000) {
            // Create temporary alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '70px';
            alert.style.right = '20px';
            alert.style.left = 'auto';
            alert.style.width = '280px';
            alert.style.zIndex = '10000';
            alert.style.maxWidth = 'calc(100vw - 40px)';
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }, duration);
        }

        // ==================== MODAL FUNCTIONS ====================
        function showModal(modalId) {
            document.getElementById(modalId)?.classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId)?.classList.remove('active');
        }

        function showCreateGroupModal() {
            showModal('createGroupModal');
            document.getElementById('groupName').focus();
        }

        function hideCreateGroupModal() {
            hideModal('createGroupModal');
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
        }

        function showJoinGroupModal() {
            showModal('joinGroupModal');
            document.getElementById('joinGroupId').focus();
        }

        function hideJoinGroupModal() {
            hideModal('joinGroupModal');
            document.getElementById('joinGroupId').value = '';
        }

        function showSettingsModal() {
            showModal('settingsModal');
        }

        function hideSettingsModal() {
            hideModal('settingsModal');
        }

        function showPrivateChatModal() {
            showModal('privateChatModal');
            document.getElementById('userSearchInput').focus();
        }

        function hidePrivateChatModal() {
            hideModal('privateChatModal');
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userSearchResults').innerHTML = '';
            document.getElementById('userSearchResults').style.display = 'none';
        }

        // ==================== AUTHENTICATION ====================
        async function handleAuthStateChange(user) {
            currentUser = user;
            
            if (user) {
                console.log('User signed in:', user.uid);
                
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        userProfile = userDoc.data();
                        updateUserUI();
                        showScreen('dashboardScreen');
                        loadUserGroups();
                        updateUserStatus('online');
                        
                        // Setup private message notifications
                        setupPrivateMessageNotifications();
                        loadPrivateChats();
                        
                    } else {
                        showScreen('registrationScreen');
                    }
                } catch (error) {
                    console.error('Error checking user profile:', error);
                    showScreen('registrationScreen');
                }
            } else {
                console.log('No user signed in');
                showScreen('welcomeScreen');
                stopAllListeners();
                
                // Stop notification listener
                if (privateMessagesListener) {
                    privateMessagesListener();
                    privateMessagesListener = null;
                }
                
                if (privateChatsListener) {
                    privateChatsListener();
                    privateChatsListener = null;
                }
            }
        }

        function formatUsername(name) {
            if (!name) return 'User';
            if (name.length > 15) {
                return name.substring(0, 12) + '...';
            }
            return name;
        }

        function updateUserUI() {
            if (userProfile) {
                const displayName = formatUsername(userProfile.username || 'User');
                document.getElementById('headerUserName').textContent = displayName;
                const initial = userProfile.username ? userProfile.username.charAt(0).toUpperCase() : 'U';
                document.getElementById('headerUserInitial').textContent = initial;
                document.getElementById('headerUserAvatarImg').style.display = 'none';
                document.getElementById('headerUserInitial').style.display = 'flex';
                
                // Update profile initial in registration screen
                document.getElementById('profileInitial').textContent = initial;
                
                if (userProfile.photoURL) {
                    document.getElementById('headerUserAvatarImg').src = userProfile.photoURL;
                    document.getElementById('headerUserAvatarImg').style.display = 'block';
                    document.getElementById('headerUserInitial').style.display = 'none';
                    
                    // Update profile preview
                    document.getElementById('profileImage').src = userProfile.photoURL;
                    document.getElementById('profileImage').style.display = 'block';
                    document.getElementById('profileInitial').style.display = 'none';
                }
            }
        }

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showAlert('Please enter both email and password', 'error');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showAlert('Signed in successfully!', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function signUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showAlert('Please enter both email and password', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAlert('Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                showAlert('Account created! Please complete your profile.', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function signOut() {
            try {
                await updateUserStatus('offline');
                stopAllListeners();
                await auth.signOut();
                showScreen('welcomeScreen');
            } catch (error) {
                console.error('Sign out error:', error);
                showAlert(error.message, 'error');
            }
        }

        async function forgotPassword() {
            const email = document.getElementById('email').value;
            if (!email) {
                showAlert('Please enter your email address', 'error');
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                showAlert('Password reset email sent! Check your inbox.', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.querySelector('#password + button i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleBtn.className = 'fas fa-eye';
            }
        }

        async function completeRegistration() {
            const username = document.getElementById('username').value.trim();
            
            if (!username || username.length < 3 || username.length > 30) {
                showAlert('Username must be 3-30 characters', 'error', 3000);
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Not authenticated');
                
                let photoURL = null;
                if (profileImageFile) {
                    photoURL = await uploadProfileImage(profileImageFile);
                }
                
                const userData = {
                    username: username,
                    email: user.email || '',
                    photoURL: photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uid: user.uid,
                    status: 'online',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(user.uid).set(userData, { merge: true });
                
                userProfile = userData;
                updateUserUI();
                showScreen('dashboardScreen');
                loadUserGroups();
                updateUserStatus('online');
                
                // Setup notifications
                setupPrivateMessageNotifications();
                loadPrivateChats();
                
                showAlert('Profile completed successfully!', 'success');
                
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function uploadProfileImage(file) {
            try {
                const user = auth.currentUser;
                if (!user) return null;
                
                const timestamp = Date.now();
                const fileName = `profile_${user.uid}_${timestamp}`;
                const storageRef = storage.ref(`profile_images/${fileName}`);
                
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                return downloadURL;
            } catch (error) {
                console.error('Profile upload error:', error);
                return null;
            }
        }

        function handleProfileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showAlert('Please select an image file', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showAlert('Image size must be less than 5MB', 'error');
                return;
            }
            
            profileImageFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('profileImage').src = e.target.result;
                document.getElementById('profileImage').style.display = 'block';
                document.getElementById('profileInitial').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        async function updateUserStatus(status) {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    status: status,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (userProfile) {
                    userProfile.status = status;
                }
                
            } catch (error) {
                console.error('Error updating user status:', error);
            }
        }

        // ==================== FILE UPLOAD FUNCTIONS ====================
        function openFilePicker(type) {
            currentChatType = type;
            const fileInput = type === 'group' ? document.getElementById('groupFileInput') : 
                            type === 'global' ? document.getElementById('globalFileInput') :
                            document.getElementById('privateFileInput');
            fileInput.click();
        }

        function handleFileSelect(event, type) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            selectedFiles = files;
            currentChatType = type;
            
            // Create preview
            const previewArea = type === 'group' ? document.getElementById('groupFilePreviewArea') : 
                              type === 'global' ? document.getElementById('globalFilePreviewArea') :
                              document.getElementById('privateFilePreviewArea');
            
            let previewHTML = '<div class="file-preview">';
            let totalSize = 0;
            
            files.forEach((file, index) => {
                totalSize += file.size;
                
                if (file.size > 10 * 1024 * 1024) {
                    showAlert(`File "${file.name}" is too large. Maximum size is 10MB.`, 'error');
                    return;
                }
                
                const fileType = file.type;
                let icon = 'fa-file';
                let color = 'var(--primary)';
                
                if (fileType.startsWith('image/')) {
                    icon = 'fa-image';
                    color = 'var(--success)';
                } else if (fileType.startsWith('video/')) {
                    icon = 'fa-video';
                    color = 'var(--danger)';
                } else if (fileType.startsWith('audio/')) {
                    icon = 'fa-music';
                    color = 'var(--warning)';
                } else if (fileType.includes('pdf')) {
                    icon = 'fa-file-pdf';
                    color = '#ef4444';
                }
                
                previewHTML += `
                    <div class="file-info" data-index="${index}">
                        <div class="file-icon">
                            <i class="fas ${icon}" style="color: ${color};"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-sm btn-danger" onclick="removeFile(${index}, '${type}')" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            previewHTML += '</div>';
            
            if (totalSize > 50 * 1024 * 1024) {
                showAlert('Total file size exceeds 50MB limit. Please select fewer files.', 'error');
                selectedFiles = [];
                previewArea.style.display = 'none';
                previewArea.innerHTML = '';
                return;
            }
            
            previewArea.innerHTML = previewHTML;
            previewArea.style.display = 'block';
        }

        function removeFile(index, type) {
            selectedFiles.splice(index, 1);
            
            if (selectedFiles.length === 0) {
                const previewArea = type === 'group' ? document.getElementById('groupFilePreviewArea') : 
                                  type === 'global' ? document.getElementById('globalFilePreviewArea') :
                                  document.getElementById('privateFilePreviewArea');
                previewArea.style.display = 'none';
                previewArea.innerHTML = '';
                
                const fileInput = type === 'group' ? document.getElementById('groupFileInput') : 
                                type === 'global' ? document.getElementById('globalFileInput') :
                                document.getElementById('privateFileInput');
                fileInput.value = '';
            } else {
                // Re-render preview with remaining files
                handleFileSelect({ target: { files: selectedFiles } }, type);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return [];
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Not authenticated');
                
                const uploadedFiles = [];
                const timestamp = Date.now();
                
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const fileName = `${user.uid}_${timestamp}_${i}_${file.name}`;
                    const storageRef = storage.ref(`uploads/${fileName}`);
                    
                    try {
                        const snapshot = await storageRef.put(file);
                        const downloadURL = await snapshot.ref.getDownloadURL();
                        
                        uploadedFiles.push({
                            url: downloadURL,
                            name: file.name,
                            type: file.type,
                            size: file.size
                        });
                    } catch (error) {
                        console.error(`Error uploading file ${file.name}:`, error);
                    }
                }
                
                return uploadedFiles;
                
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('Upload failed: ' + error.message, 'error');
                return [];
            }
        }

        // ==================== @MENTION PROCESSING ====================
        function processMentions(text) {
            if (!text) return text;
            
            // Replace @username with mention spans
            return text.replace(/@(\w+)/g, function(match, username) {
                return `<span class="mention">${username}</span>`;
            });
        }

        // ==================== GROUP MANAGEMENT ====================
        async function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            const description = document.getElementById('groupDescription').value.trim();
            const type = document.getElementById('groupType').value;
            
            if (!name) {
                showAlert('Group name is required', 'error');
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Not authenticated');
                
                const username = userProfile?.username || user.email || 'Anonymous';
                
                // Create group document
                const groupRef = db.collection('groups').doc();
                const groupId = groupRef.id;
                
                const groupData = {
                    id: groupId,
                    name: name,
                    description: description,
                    ownerId: user.uid,
                    ownerName: username,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    memberCount: 1,
                    isPublic: type === 'public',
                    type: type,
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await groupRef.set(groupData);
                
                // Add creator as member
                await groupRef.collection('members').doc(user.uid).set({
                    userId: user.uid,
                    username: username,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    role: 'admin',
                    photoURL: userProfile?.photoURL || null
                });
                
                // Add welcome message
                await groupRef.collection('messages').add({
                    senderId: 'system',
                    senderName: 'System',
                    text: `${username} created the group "${name}"`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'system'
                });
                
                showAlert(`Group "${name}" created successfully!`, 'success');
                
                setTimeout(() => {
                    hideCreateGroupModal();
                    loadUserGroups();
                    joinGroupChat(groupId, name);
                }, 1500);
                
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function joinGroup() {
            const groupId = document.getElementById('joinGroupId').value.trim();
            
            if (!groupId) {
                showAlert('Please enter a Group ID', 'error');
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Please sign in first');
                
                // Check if group exists
                const groupRef = db.collection('groups').doc(groupId);
                const groupDoc = await groupRef.get();
                
                if (!groupDoc.exists) {
                    throw new Error('Group not found. Check the Group ID.');
                }
                
                const groupData = groupDoc.data();
                
                // Check if already a member
                const memberRef = groupRef.collection('members').doc(user.uid);
                const memberDoc = await memberRef.get();
                
                if (memberDoc.exists) {
                    showAlert('You are already a member of this group', 'info');
                    joinGroupChat(groupId, groupData.name);
                    return;
                }
                
                const username = userProfile?.username || user.email || 'Anonymous';
                
                // Join group
                await memberRef.set({
                    userId: user.uid,
                    username: username,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    role: 'member',
                    photoURL: userProfile?.photoURL || null
                });
                
                // Update member count
                await groupRef.update({
                    memberCount: firebase.firestore.FieldValue.increment(1),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add join message
                await groupRef.collection('messages').add({
                    senderId: 'system',
                    senderName: 'System',
                    text: `${username} joined the group`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'system'
                });
                
                hideJoinGroupModal();
                loadUserGroups();
                joinGroupChat(groupId, groupData.name);
                showAlert(`Joined "${groupData.name}" successfully!`, 'success');
                
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function loadUserGroups() {
            const groupsList = document.getElementById('groupsList');
            
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                // Get all groups where user is a member
                const groupsSnapshot = await db.collection('groups').get();
                const userGroups = [];
                
                for (const groupDoc of groupsSnapshot.docs) {
                    const memberDoc = await db.collection('groups').doc(groupDoc.id).collection('members').doc(user.uid).get();
                    if (memberDoc.exists) {
                        userGroups.push({
                            id: groupDoc.id,
                            ...groupDoc.data()
                        });
                    }
                }
                
                if (userGroups.length === 0) {
                    groupsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">No Groups Yet</div>
                            <p class="empty-state-description">You haven't joined any groups. Create or join one to get started!</p>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="showCreateGroupModal()">
                                    <i class="fas fa-plus"></i> Create Group
                                </button>
                                <button class="btn btn-sm btn-success" onclick="searchAndJoinGroup()">
                                    <i class="fas fa-search"></i> Search Groups
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Sort by last activity
                userGroups.sort((a, b) => {
                    const timeA = a.lastActivity?.toDate?.() || a.createdAt?.toDate?.() || new Date(0);
                    const timeB = b.lastActivity?.toDate?.() || b.createdAt?.toDate?.() || new Date(0);
                    return timeB - timeA;
                });
                
                // Render groups
                groupsList.innerHTML = userGroups.map(group => {
                    const isActive = currentGroup === group.id && currentGroupType === 'group';
                    const badgeType = group.isPublic ? 'public' : 'private';
                    const badgeText = group.isPublic ? 'Public' : 'Private';
                    const displayName = group.name.length > 30 ? group.name.substring(0, 27) + '...' : group.name;
                    
                    return `
                        <div class="group-item ${isActive ? 'active' : ''}" 
                             onclick="joinGroupChat('${group.id}', '${group.name.replace(/'/g, "\\'")}')">
                            <div class="group-header">
                                <div class="group-name" title="${group.name}">${displayName}</div>
                                <div class="group-meta">
                                    <span class="group-badge ${badgeType}">${badgeText}</span>
                                    <span>${group.memberCount || 0} members</span>
                                    <span></span>
                                    <span>${formatDate(group.lastActivity?.toDate?.() || group.createdAt?.toDate?.())}</span>
                                </div>
                            </div>
                            ${group.description ? `<div class="group-description">${group.description}</div>` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading groups:', error);
                groupsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">Error Loading Groups</div>
                        <p class="empty-state-description">${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadPublicGroups() {
            const publicGroupsList = document.getElementById('publicGroupsList');
            
            try {
                publicGroupsList.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div class="loading-text">Loading public groups...</div></div>';
                
                // NOTE: This query requires a Firestore composite index
                // Create index in Firebase Console with:
                // Collection: groups, Fields: isPublic (Ascending), lastActivity (Descending)
                
                const snapshot = await db.collection('groups')
                    .where('isPublic', '==', true)
                    .orderBy('lastActivity', 'desc')
                    .limit(30)
                    .get();
                
                if (snapshot.empty) {
                    publicGroupsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">No Public Groups Found</div>
                            <p class="empty-state-description">Be the first to create a public group!</p>
                            <div class="action-buttons" style="margin-top: 20px;">
                                <button class="btn btn-sm btn-primary" onclick="showCreateGroupModal()">
                                    <i class="fas fa-plus"></i> Create Group
                                </button>
                                <button class="btn btn-sm btn-success" onclick="searchAndJoinGroup()">
                                    <i class="fas fa-search"></i> Search All Groups
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const groups = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                window.publicGroupsCache = groups;
                renderPublicGroups(groups);
                
            } catch (error) {
                console.error('Error loading public groups:', error);
                
                let errorMessage = error.message;
                if (error.code === 'failed-precondition') {
                    errorMessage = "Firestore index needed for public groups. Please create composite index in Firebase Console: fields - isPublic (Ascending), lastActivity (Descending)";
                }
                
                publicGroupsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">Error Loading Groups</div>
                        <p class="empty-state-description">${errorMessage}</p>
                        <div class="action-buttons" style="margin-top: 20px;">
                            <button class="btn btn-sm btn-secondary" onclick="loadPublicGroups()">
                                <i class="fas fa-sync"></i> Try Again
                            </button>
                            <button class="btn btn-sm btn-success" onclick="searchAndJoinGroup()">
                                <i class="fas fa-search"></i> Search Groups
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function renderPublicGroups(groups) {
            const publicGroupsList = document.getElementById('publicGroupsList');
            
            publicGroupsList.innerHTML = groups.map(group => {
                const badgeType = group.isPublic ? 'public' : 'private';
                const badgeText = group.isPublic ? 'Public' : 'Private';
                const displayName = group.name.length > 30 ? group.name.substring(0, 27) + '...' : group.name;
                const displayDesc = group.description && group.description.length > 80 ? group.description.substring(0, 77) + '...' : group.description;
                
                return `
                    <div class="group-item" data-group-id="${group.id}">
                        <div class="group-header">
                            <div class="group-name" title="${group.name}">${displayName}</div>
                            <div class="group-meta">
                                <span class="group-badge ${badgeType}">${badgeText}</span>
                                <span>${group.memberCount || 0} members</span>
                                <span></span>
                                <span>${formatDate(group.lastActivity?.toDate?.() || group.createdAt?.toDate?.())}</span>
                            </div>
                        </div>
                        ${group.description ? `<div class="group-description">${displayDesc || ''}</div>` : ''}
                        <div class="group-actions">
                            <button class="btn btn-sm btn-primary" onclick="joinPublicGroup('${group.id}')">
                                <i class="fas fa-sign-in-alt"></i> Join
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="viewGroupDetails('${group.id}')">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="copyGroupId('${group.id}')">
                                <i class="fas fa-copy"></i> Copy ID
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function joinPublicGroup(groupId) {
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Please sign in first');
                
                const groupRef = db.collection('groups').doc(groupId);
                const groupDoc = await groupRef.get();
                
                if (!groupDoc.exists) {
                    throw new Error('Group not found');
                }
                
                const groupData = groupDoc.data();
                const username = userProfile?.username || user.email || 'Anonymous';
                
                // Check if already a member
                const memberDoc = await groupRef.collection('members').doc(user.uid).get();
                if (memberDoc.exists) {
                    joinGroupChat(groupId, groupData.name);
                    return;
                }
                
                // Join group
                await groupRef.collection('members').doc(user.uid).set({
                    userId: user.uid,
                    username: username,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    role: 'member',
                    photoURL: userProfile?.photoURL || null
                });
                
                // Update member count
                await groupRef.update({
                    memberCount: firebase.firestore.FieldValue.increment(1),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add join message
                await groupRef.collection('messages').add({
                    senderId: 'system',
                    senderName: 'System',
                    text: `${username} joined the group`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'system'
                });
                
                showAlert(`Joined "${groupData.name}" successfully!`, 'success');
                loadUserGroups();
                joinGroupChat(groupId, groupData.name);
                
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // ==================== SEARCH FUNCTIONS ====================
        async function searchAndJoinGroup() {
            const searchTerm = prompt("Enter group name or ID to search:");
            if (!searchTerm) return;
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Please sign in first');
                
                // Search by group name
                const snapshot = await db.collection('groups')
                    .where('name', '>=', searchTerm)
                    .where('name', '<=', searchTerm + '\uf8ff')
                    .limit(10)
                    .get();
                
                if (snapshot.empty) {
                    showAlert(`No groups found matching "${searchTerm}"`, 'info');
                    return;
                }
                
                const groups = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Create selection dialog
                let groupList = "Select a group to join:\n\n";
                groups.forEach((group, index) => {
                    groupList += `${index + 1}. ${group.name} (${group.isPublic ? 'Public' : 'Private'}) - ${group.memberCount || 0} members\n`;
                });
                
                const choice = prompt(groupList + "\nEnter the group number:");
                if (!choice || isNaN(choice) || choice < 1 || choice > groups.length) {
                    return;
                }
                
                const selectedGroup = groups[choice - 1];
                await joinPublicGroup(selectedGroup.id);
                
            } catch (error) {
                console.error('Search error:', error);
                showAlert(error.message, 'error');
            }
        }

        async function viewGroupDetails(groupId) {
            try {
                const groupDoc = await db.collection('groups').doc(groupId).get();
                if (!groupDoc.exists) {
                    showAlert('Group not found', 'error');
                    return;
                }
                
                const group = groupDoc.data();
                const membersSnapshot = await db.collection('groups').doc(groupId).collection('members').limit(10).get();
                const members = membersSnapshot.docs.map(doc => doc.data());
                
                let details = `
                    Group: ${group.name}
                    ${group.description ? `\nDescription: ${group.description}` : ''}
                    Type: ${group.isPublic ? 'Public' : 'Private'}
                    Owner: ${group.ownerName}
                    Members: ${group.memberCount || 0}
                    Created: ${group.createdAt?.toDate?.().toLocaleDateString() || 'Unknown'}
                    
                    Recent Members:
                `;
                
                members.slice(0, 5).forEach(member => {
                    details += `\n ${member.username} (${member.role})`;
                });
                
                if (group.memberCount > 5) {
                    details += `\n... and ${group.memberCount - 5} more`;
                }
                
                const join = confirm(`${details}\n\nDo you want to join this group?`);
                if (join) {
                    await joinPublicGroup(groupId);
                }
                
            } catch (error) {
                console.error('Error viewing group details:', error);
                showAlert(error.message, 'error');
            }
        }

        function copyGroupId(groupId) {
            navigator.clipboard.writeText(groupId)
                .then(() => {
                    showAlert(`Group ID copied to clipboard: ${groupId}`, 'success');
                })
                .catch(err => {
                    console.error('Copy failed:', err);
                    prompt('Group ID (copy manually):', groupId);
                });
        }

        function searchMyGroups() {
            const searchTerm = document.getElementById('searchMyGroups').value.toLowerCase();
            const groups = document.querySelectorAll('#groupsList .group-item');
            let hasVisible = false;
            
            groups.forEach(group => {
                const name = group.querySelector('.group-name').textContent.toLowerCase();
                const description = group.querySelector('.group-description')?.textContent.toLowerCase() || '';
                
                if (name.includes(searchTerm) || description.includes(searchTerm)) {
                    group.style.display = 'flex';
                    hasVisible = true;
                } else {
                    group.style.display = 'none';
                }
            });
            
            if (!hasVisible && searchTerm) {
                const groupsList = document.getElementById('groupsList');
                groupsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">No Groups Found</div>
                        <p class="empty-state-description">No groups match "${searchTerm}"</p>
                    </div>
                `;
            }
        }

        function searchPublicGroups() {
            const searchTerm = document.getElementById('searchPublicGroups').value.toLowerCase();
            const groups = window.publicGroupsCache || [];
            
            const filteredGroups = groups.filter(group => 
                group.name.toLowerCase().includes(searchTerm) || 
                (group.description && group.description.toLowerCase().includes(searchTerm))
            );
            
            if (filteredGroups.length === 0) {
                const publicGroupsList = document.getElementById('publicGroupsList');
                publicGroupsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">No Groups Found</div>
                        <p class="empty-state-description">No public groups match "${searchTerm}"</p>
                        <div class="action-buttons" style="margin-top: 20px;">
                            <button class="btn btn-sm btn-primary" onclick="showCreateGroupModal()">
                                <i class="fas fa-plus"></i> Create Group
                            </button>
                            <button class="btn btn-sm btn-success" onclick="searchAndJoinGroup()">
                                <i class="fas fa-search"></i> Search All Groups
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            renderPublicGroups(filteredGroups);
        }

        function refreshPublicGroups() {
            loadPublicGroups();
        }

        // ==================== REACTIONS FUNCTIONS ====================
        async function addReaction(messageId, chatType, emoji) {
            try {
                const user = auth.currentUser;
                if (!user) return;

                let collectionPath;
                if (chatType === 'group' && currentGroup) {
                    collectionPath = `groups/${currentGroup}/messages`;
                } else if (chatType === 'global') {
                    collectionPath = 'global_chat';
                } else if (chatType === 'private' && currentPrivateChatId) {
                    collectionPath = `private_chats/${currentPrivateChatId}/messages`;
                } else {
                    return;
                }

                const messageRef = db.collection(collectionPath).doc(messageId);
                const messageDoc = await messageRef.get();
                
                if (!messageDoc.exists) return;

                const reactions = messageDoc.data().reactions || {};
                const userReaction = reactions[user.uid];
                
                if (userReaction === emoji) {
                    // Remove reaction if already exists
                    delete reactions[user.uid];
                } else {
                    // Add/update reaction
                    reactions[user.uid] = emoji;
                }
                
                await messageRef.update({
                    reactions: reactions,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            } catch (error) {
                console.error('Error adding reaction:', error);
            }
        }

        function renderReactions(reactions, messageId, chatType) {
            if (!reactions || Object.keys(reactions).length === 0) return '';

            // Count reactions by emoji
            const reactionCounts = {};
            Object.values(reactions).forEach(emoji => {
                reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
            });

            const user = auth.currentUser;
            const userReaction = user ? reactions[user.uid] : null;

            return Object.entries(reactionCounts).map(([emoji, count]) => {
                const isActive = emoji === userReaction;
                return `
                    <button class="reaction-btn ${isActive ? 'active' : ''}" 
                            onclick="addReaction('${messageId}', '${chatType}', '${emoji}')">
                        <span class="reaction-emoji">${emoji}</span>
                        <span class="reaction-count">${count}</span>
                    </button>
                `;
            }).join('');
        }

        // ==================== REPOST FUNCTIONS ====================
        async function repostMessage(messageId, chatType, originalChatType = null, originalGroupId = null) {
            try {
                const user = auth.currentUser;
                if (!user) return;

                const username = userProfile?.username || user.email || 'Anonymous';
                
                let repostText = '';
                let originalMessage = null;
                
                // Get original message
                if (originalChatType === 'group' && originalGroupId) {
                    const messageDoc = await db.collection(`groups/${originalGroupId}/messages`).doc(messageId).get();
                    originalMessage = messageDoc.data();
                } else if (originalChatType === 'global') {
                    const messageDoc = await db.collection('global_chat').doc(messageId).get();
                    originalMessage = messageDoc.data();
                }
                
                if (originalMessage) {
                    const truncatedText = originalMessage.text ? 
                        (originalMessage.text.length > 100 ? 
                         originalMessage.text.substring(0, 97) + '...' : 
                         originalMessage.text) : 
                        'Shared content';
                    
                    repostText = ` Reposted: ${originalMessage.senderName}: ${truncatedText}`;
                } else {
                    repostText = ` Reposted by ${username}`;
                }

                // Add repost to current chat
                if (chatType === 'group' && currentGroup) {
                    await db.collection(`groups/${currentGroup}/messages`).add({
                        senderId: user.uid,
                        senderName: username,
                        text: repostText,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'repost',
                        originalMessageId: messageId,
                        originalChatType: originalChatType,
                        originalGroupId: originalGroupId
                    });
                } else if (chatType === 'global') {
                    await db.collection('global_chat').add({
                        senderId: user.uid,
                        senderName: username,
                        text: repostText,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'repost',
                        originalMessageId: messageId,
                        originalChatType: originalChatType
                    });
                } else if (chatType === 'private' && currentPrivateChatId) {
                    await db.collection(`private_chats/${currentPrivateChatId}/messages`).add({
                        senderId: user.uid,
                        senderName: username,
                        text: repostText,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'repost',
                        originalMessageId: messageId,
                        originalChatType: originalChatType,
                        originalGroupId: originalGroupId
                    });
                }

            } catch (error) {
                console.error('Error reposting:', error);
                showAlert('Failed to repost message', 'error');
            }
        }

        function renderRepostIndicator(message) {
            if (message.type !== 'repost') return '';
            
            let originalText = 'Shared content';
            if (message.originalChatType === 'group') {
                originalText = `From group chat`;
            } else if (message.originalChatType === 'global') {
                originalText = `From global chat`;
            }
            
            return `
                <div class="repost-indicator">
                    <i class="fas fa-retweet repost-icon"></i>
                    <span>${originalText}</span>
                </div>
            `;
        }

        // ==================== PRIVATE MESSAGING ====================
        async function searchUsers(searchTerm) {
            const resultsDiv = document.getElementById('userSearchResults');
            
            if (!searchTerm || searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                // Search users by username
                const usersSnapshot = await db.collection('users')
                    .where('username', '>=', searchTerm)
                    .where('username', '<=', searchTerm + '\uf8ff')
                    .limit(10)
                    .get();
                
                if (usersSnapshot.empty) {
                    resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray);">No users found</div>';
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                const users = usersSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(userData => userData.id !== user.uid); // Exclude current user
                
                resultsDiv.innerHTML = users.map(userData => {
                    const statusClass = userData.status || 'offline';
                    const statusText = userData.status === 'online' ? 'Online' : 
                                     userData.status === 'away' ? 'Away' : 'Offline';
                    
                    return `
                        <div class="user-search-item" onclick="startPrivateChat('${userData.id}', '${userData.username}')">
                            <div class="user-search-avatar">
                                ${userData.username ? userData.username.charAt(0).toUpperCase() : 'U'}
                            </div>
                            <div class="user-search-info">
                                <div class="user-search-name">${userData.username || 'Unknown'}</div>
                                <div class="user-search-status">
                                    <div class="user-status-dot ${statusClass}"></div>
                                    <span>${statusText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                resultsDiv.style.display = 'block';
                
            } catch (error) {
                console.error('Error searching users:', error);
                resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Error searching users</div>';
                resultsDiv.style.display = 'block';
            }
        }

        async function startPrivateChat(otherUserId, otherUsername) {
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Please sign in');
                
                // Create or get private chat ID
                const chatId = [user.uid, otherUserId].sort().join('_');
                
                console.log('Starting private chat with ID:', chatId);
                
                // Check if chat already exists
                const chatRef = db.collection('private_chats').doc(chatId);
                const chatDoc = await chatRef.get();
                
                if (!chatDoc.exists) {
                    console.log('Creating new private chat document...');
                    
                    // Create new private chat
                    const chatData = {
                        participants: [user.uid, otherUserId],
                        participantNames: {
                            [user.uid]: userProfile?.username || user.email || 'Anonymous',
                            [otherUserId]: otherUsername
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: user.uid
                    };
                    
                    console.log('Chat data to create:', chatData);
                    
                    try {
                        await chatRef.set(chatData);
                        console.log('Private chat document created successfully');
                        
                        // Add initial system message
                        await chatRef.collection('messages').add({
                            senderId: 'system',
                            senderName: 'System',
                            text: `Private chat started between ${userProfile?.username || 'You'} and ${otherUsername}`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            type: 'system'
                        });
                        
                        console.log('Initial system message added');
                    } catch (createError) {
                        console.error('Error creating private chat:', createError);
                        throw createError;
                    }
                } else {
                    console.log('Private chat already exists:', chatDoc.data());
                }
                
                privateChatUser = {
                    id: otherUserId,
                    username: otherUsername
                };
                currentPrivateChatId = chatId;
                
                hidePrivateChatModal();
                showPrivateChatScreen();
                loadPrivateMessages();
                
                // Mark as read
                markPrivateChatAsRead(chatId);
                
                showAlert(`Private chat with ${otherUsername} started successfully!`, 'success');
                
            } catch (error) {
                console.error('Error starting private chat:', error);
                console.error('Error details:', error.code, error.message, error.stack);
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        async function loadPrivateChats() {
            if (!currentUser) return;
            
            const privateChatsList = document.getElementById('privateChatsList');
            
            try {
                privateChatsListener = db.collection('private_chats')
                    .where('participants', 'array-contains', currentUser.uid)
                    // .orderBy('lastActivity', 'desc') // Temporarily removed due to index requirement
                    .onSnapshot(async (snapshot) => {
                        const chats = [];
                        
                        for (const chatDoc of snapshot.docs) {
                            const chatData = chatDoc.data();
                            const otherUserId = chatData.participants.find(id => id !== currentUser.uid);
                            const otherUsername = chatData.participantNames?.[otherUserId] || 'Unknown';
                            
                            // Get last message
                            const messagesQuery = await chatDoc.ref.collection('messages')
                                .orderBy('timestamp', 'desc')
                                .limit(1)
                                .get();
                            
                            let lastMessage = 'No messages yet';
                            let lastMessageTime = chatData.lastActivity?.toDate?.() || new Date();
                            let unread = false;
                            
                            if (!messagesQuery.empty) {
                                const lastMsg = messagesQuery.docs[0].data();
                                lastMessage = lastMsg.text || 'File shared';
                                lastMessageTime = lastMsg.timestamp?.toDate?.() || lastMessageTime;
                                
                                // Check if unread
                                const lastReadKey = `lastRead_${chatDoc.id}`;
                                const lastRead = localStorage.getItem(lastReadKey);
                                const lastMessageTimeMs = lastMsg.timestamp?.toMillis?.() || 0;
                                
                                if (!lastRead || lastMessageTimeMs > parseInt(lastRead)) {
                                    if (lastMsg.senderId !== currentUser.uid) {
                                        unread = true;
                                    }
                                }
                            }
                            
                            chats.push({
                                id: chatDoc.id,
                                otherUserId: otherUserId,
                                otherUsername: otherUsername,
                                lastMessage: lastMessage,
                                lastActivity: lastMessageTime,
                                unread: unread
                            });
                        }
                        
                        // Sort manually by lastActivity (since we removed orderBy due to index requirement)
                        chats.sort((a, b) => {
                            return b.lastActivity - a.lastActivity;
                        });
                        
                        renderPrivateChats(chats);
                    }, (error) => {
                        console.error('Error loading private chats:', error);
                        
                        let errorMessage = error.message;
                        if (error.code === 'failed-precondition') {
                            errorMessage = "Firestore index needed for private chats. Please create composite index in Firebase Console: fields - participants (Array), lastActivity (Descending)";
                        }
                        
                        privateChatsList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <div class="empty-state-title">Firestore Index Required</div>
                                <p class="empty-state-description">${errorMessage}</p>
                                <div class="action-buttons" style="margin-top: 20px;">
                                    <button class="btn btn-sm btn-secondary" onclick="loadPrivateChats()">
                                        <i class="fas fa-sync"></i> Try Again
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="showPrivateChatModal()">
                                        <i class="fas fa-user-plus"></i> New Chat
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                
            } catch (error) {
                console.error('Error setting up private chats listener:', error);
                privateChatsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">Error Loading Chats</div>
                        <p class="empty-state-description">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderPrivateChats(chats) {
            const privateChatsList = document.getElementById('privateChatsList');
            
            if (chats.length === 0) {
                privateChatsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">No Private Chats</div>
                        <p class="empty-state-description">Start a private conversation with another user.</p>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="showPrivateChatModal()">
                                <i class="fas fa-user-plus"></i> New Private Chat
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            privateChatsList.innerHTML = chats.map(chat => {
                const displayName = chat.otherUsername.length > 20 ? chat.otherUsername.substring(0, 17) + '...' : chat.otherUsername;
                const displayMessage = chat.lastMessage.length > 40 ? chat.lastMessage.substring(0, 37) + '...' : chat.lastMessage;
                const timeAgo = formatDate(chat.lastActivity);
                
                return `
                    <div class="chat-item ${chat.unread ? 'active' : ''}" onclick="openPrivateChat('${chat.id}', '${chat.otherUserId}', '${chat.otherUsername.replace(/'/g, "\\'")}')">
                        <div class="chat-header">
                            <div class="chat-name" title="${chat.otherUsername}">
                                ${displayName}
                                ${chat.unread ? '<span class="chat-badge unread" style="margin-left: 6px;">New</span>' : ''}
                            </div>
                            <div class="chat-meta">
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                        <div class="chat-last-message ${chat.unread ? 'unread' : ''}" title="${chat.lastMessage}">
                            ${displayMessage}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update notification count
            updatePrivateNotificationCount();
        }

        function openPrivateChat(chatId, otherUserId, otherUsername) {
            privateChatUser = {
                id: otherUserId,
                username: otherUsername
            };
            currentPrivateChatId = chatId;
            
            showPrivateChatScreen();
            loadPrivateMessages();
            
            // Mark as read when opening
            markPrivateChatAsRead(chatId);
        }

        function searchPrivateChats() {
            const searchTerm = document.getElementById('searchPrivateChats').value.toLowerCase();
            const chats = document.querySelectorAll('#privateChatsList .chat-item');
            let hasVisible = false;
            
            chats.forEach(chat => {
                const name = chat.querySelector('.chat-name').textContent.toLowerCase();
                const lastMessage = chat.querySelector('.chat-last-message')?.textContent.toLowerCase() || '';
                
                if (name.includes(searchTerm) || lastMessage.includes(searchTerm)) {
                    chat.style.display = 'flex';
                    hasVisible = true;
                } else {
                    chat.style.display = 'none';
                }
            });
            
            if (!hasVisible && searchTerm) {
                const privateChatsList = document.getElementById('privateChatsList');
                privateChatsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">No Chats Found</div>
                        <p class="empty-state-description">No private chats match "${searchTerm}"</p>
                    </div>
                `;
            }
        }

        async function startPrivateChatFromMessage(userId, username) {
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Please sign in');
                
                // Create chat ID
                const chatId = [user.uid, userId].sort().join('_');
                
                console.log('Starting private chat from message with ID:', chatId);
                
                // Check if chat exists
                const chatRef = db.collection('private_chats').doc(chatId);
                const chatDoc = await chatRef.get();
                
                if (!chatDoc.exists) {
                    await chatRef.set({
                        participants: [user.uid, userId],
                        participantNames: {
                            [user.uid]: userProfile?.username || user.email || 'Anonymous',
                            [userId]: username
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Add initial message
                    await chatRef.collection('messages').add({
                        senderId: 'system',
                        senderName: 'System',
                        text: `Private chat started between ${userProfile?.username || 'You'} and ${username}`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'system'
                    });
                }
                
                privateChatUser = {
                    id: userId,
                    username: username
                };
                currentPrivateChatId = chatId;
                
                showPrivateChatScreen();
                loadPrivateMessages();
                
                // Mark as read
                markPrivateChatAsRead(chatId);
                
            } catch (error) {
                console.error('Error starting private chat from message:', error);
                showAlert(error.message, 'error');
            }
        }

        function showPrivateChatScreen() {
            stopAllListeners();
            
            document.getElementById('privateChatUserName').textContent = privateChatUser?.username || 'Private Chat';
            document.getElementById('privateChatMessages').innerHTML = '<div class="loading"><div class="loading-spinner"></div><div class="loading-text">Loading private chat...</div></div>';
            
            showScreen('privateChatScreen');
            
            setTimeout(() => {
                document.getElementById('privateMessageInput').focus();
            }, 100);
        }

        function loadPrivateMessages() {
            if (!currentPrivateChatId) return;
            
            const messagesArea = document.getElementById('privateChatMessages');
            
            privateChatListener = db.collection(`private_chats/${currentPrivateChatId}/messages`)
                .orderBy('timestamp', 'asc')
                .limitToLast(100)
                .onSnapshot((snapshot) => {
                    const messages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp?.toDate()
                    }));
                    
                    renderPrivateMessages(messages);
                    
                    setTimeout(() => {
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }, 100);
                    
                }, (error) => {
                    console.error('Error loading private messages:', error);
                    messagesArea.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <div class="empty-state-title">Error Loading Messages</div>
                            <p class="empty-state-description">${error.message}</p>
                        </div>
                    `;
                });
        }

        function renderPrivateMessages(messages) {
            const messagesArea = document.getElementById('privateChatMessages');
            
            if (messages.length === 0) {
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">Private Chat</div>
                        <p class="empty-state-description">Your messages are end-to-end encrypted. Start a conversation!</p>
                    </div>
                `;
                return;
            }
            
            let lastDate = null;
            messagesArea.innerHTML = '';
            
            messages.forEach(message => {
                const messageDate = message.timestamp?.toDateString();
                
                if (messageDate !== lastDate) {
                    lastDate = messageDate;
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'date-separator';
                    dateSeparator.innerHTML = `<span>${formatDate(message.timestamp, true)}</span>`;
                    messagesArea.appendChild(dateSeparator);
                }
                
                const isCurrentUser = message.senderId === currentUser?.uid;
                const isSystem = message.type === 'system';
                
                if (isSystem) {
                    const systemMsg = document.createElement('div');
                    systemMsg.className = 'message system';
                    systemMsg.innerHTML = `
                        <div class="message-bubble">${message.text}</div>
                    `;
                    messagesArea.appendChild(systemMsg);
                    return;
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isCurrentUser ? 'sent' : ''}`;
                
                let content = '';
                
                // Handle file messages
                if (message.type === 'file' && message.file) {
                    const file = message.file;
                    if (file.type.startsWith('image/')) {
                        content = `
                            <div class="message-file">
                                <img src="${file.url}" alt="${file.name}" 
                                     style="max-width: 250px; max-height: 250px; border-radius: 8px; cursor: pointer;" 
                                     onclick="window.open('${file.url}', '_blank')">
                                <div class="file-meta">
                                    <small>${file.name}</small>
                                    <small>${formatFileSize(file.size)}</small>
                                </div>
                            </div>
                        `;
                    } else if (file.type.startsWith('video/')) {
                        content = `
                            <div class="message-file">
                                <video controls style="max-width: 250px; max-height: 250px; border-radius: 8px;">
                                    <source src="${file.url}" type="${file.type}">
                                </video>
                                <div class="file-meta">
                                    <small>${file.name}</small>
                                    <small>${formatFileSize(file.size)}</small>
                                </div>
                            </div>
                        `;
                    } else {
                        content = `
                            <div class="message-file">
                                <div class="file-download" onclick="window.open('${file.url}', '_blank')">
                                    <i class="fas fa-file" style="font-size: 22px; color: var(--primary);"></i>
                                    <div>
                                        <div><strong>${file.name}</strong></div>
                                        <small>${formatFileSize(file.size)}</small>
                                    </div>
                                    <i class="fas fa-download" style="margin-left: auto;"></i>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Handle repost
                if (message.type === 'repost') {
                    content += renderRepostIndicator(message);
                }
                
                // Handle text with @mentions
                if (message.text) {
                    content += `<div class="message-content">${processMentions(escapeHtml(message.text))}</div>`;
                }
                
                // Reactions
                let reactionsHTML = '';
                if (message.reactions && Object.keys(message.reactions).length > 0) {
                    reactionsHTML = `<div class="message-reactions">${renderReactions(message.reactions, message.id, 'private')}</div>`;
                }
                
                const senderName = message.senderName || 'Unknown';
                const avatarContent = senderName.charAt(0).toUpperCase();
                
                messageElement.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-header">
                            <div class="message-sender">
                                ${!isCurrentUser ? senderName : 'You'}
                            </div>
                            <div class="message-time">${formatTime(message.timestamp)}</div>
                        </div>
                        ${content}
                        ${reactionsHTML}
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="addReaction('${message.id}', 'private', '')" title="Love">
                                
                            </button>
                            <button class="message-action-btn" onclick="addReaction('${message.id}', 'private', '')" title="Like">
                                
                            </button>
                            <button class="message-action-btn" onclick="repostMessage('${message.id}', 'private', '${message.originalChatType}', '${message.originalGroupId}')" title="Repost">
                                
                            </button>
                            ${!isCurrentUser ? `
                            <button class="message-action-btn" onclick="replyToUser('${senderName}')" title="Reply">
                                @
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                messagesArea.appendChild(messageElement);
            });
        }

        async function sendPrivateMessage() {
            const input = document.getElementById('privateMessageInput');
            const text = input.value.trim();
            
            if (!text && selectedFiles.length === 0) return;
            
            try {
                const user = auth.currentUser;
                if (!user || !currentPrivateChatId) throw new Error('Not in private chat');
                
                const username = userProfile?.username || user.email || 'Anonymous';
                
                let filesData = [];
                if (selectedFiles.length > 0 && currentChatType === 'private') {
                    filesData = await uploadFiles();
                }
                
                const messageData = {
                    senderId: user.uid,
                    senderName: username,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: filesData.length > 0 ? 'file' : 'text'
                };
                
                if (text) {
                    messageData.text = text;
                }
                
                if (filesData.length > 0) {
                    if (filesData.length === 1) {
                        messageData.file = filesData[0];
                    } else {
                        messageData.files = filesData;
                        messageData.text = text || `${filesData.length} files uploaded`;
                    }
                }
                
                await db.collection(`private_chats/${currentPrivateChatId}/messages`).add(messageData);
                
                // Update last activity
                await db.collection('private_chats').doc(currentPrivateChatId).update({
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Clear input and file preview
                input.value = '';
                input.style.height = 'auto';
                if (currentChatType === 'private') {
                    selectedFiles = [];
                    document.getElementById('privateFilePreviewArea').style.display = 'none';
                    document.getElementById('privateFilePreviewArea').innerHTML = '';
                    document.getElementById('privateFileInput').value = '';
                }
                
            } catch (error) {
                console.error('Send error:', error);
                showAlert(`Error sending message: ${error.message}`, 'error');
            }
        }

        function endPrivateChat() {
            if (privateChatListener) {
                privateChatListener();
                privateChatListener = null;
            }
            
            privateChatUser = null;
            currentPrivateChatId = null;
            
            showScreen('dashboardScreen');
            showTab('privateChatsTab');
        }

        function showPrivateChatInfo() {
            if (!privateChatUser) return;
            
            showAlert(
                `Private Chat with ${privateChatUser.username}\n\n Messages are end-to-end encrypted\n Only you and ${privateChatUser.username} can see these messages\n Chat history is saved`,
                'info'
            );
        }

        // ==================== NOTIFICATION FUNCTIONS ====================
        function setupPrivateMessageNotifications() {
            if (!currentUser) return;
            
            // Stop previous listener
            if (privateMessagesListener) {
                privateMessagesListener();
            }
            
            // Listen for all private chats where user is a participant
            privateMessagesListener = db.collection('private_chats')
                .where('participants', 'array-contains', currentUser.uid)
                .onSnapshot(async (snapshot) => {
                    updatePrivateNotificationCount();
                    
                    // Check for new messages when not viewing that chat
                    if (currentPrivateChatId) {
                        // User is viewing a chat, only check others
                        return;
                    }
                    
                    for (const chatDoc of snapshot.docs) {
                        const chatId = chatDoc.id;
                        if (chatId === currentPrivateChatId) continue;
                        
                        const lastReadKey = `lastRead_${chatId}`;
                        const lastRead = localStorage.getItem(lastReadKey);
                        
                        // Get the last message
                        const messagesQuery = await chatDoc.ref.collection('messages')
                            .orderBy('timestamp', 'desc')
                            .limit(1)
                            .get();
                        
                        if (!messagesQuery.empty) {
                            const lastMessage = messagesQuery.docs[0].data();
                            const lastMessageTime = lastMessage.timestamp?.toMillis?.() || 0;
                            
                            // If never read or new messages since last read
                            if (!lastRead || lastMessageTime > parseInt(lastRead)) {
                                // Don't count if current user sent the message
                                if (lastMessage.senderId !== currentUser.uid) {
                                    // Show notification for new messages
                                    if (lastRead && settings.notificationSound) {
                                        handleNewPrivateMessage(chatId, lastMessage);
                                    }
                                }
                            }
                        }
                    }
                });
        }

        function updatePrivateNotificationCount() {
            if (!currentUser) return;
            
            // Get all private chats and count unread
            db.collection('private_chats')
                .where('participants', 'array-contains', currentUser.uid)
                .get()
                .then(async (snapshot) => {
                    let totalUnread = 0;
                    
                    for (const chatDoc of snapshot.docs) {
                        const chatId = chatDoc.id;
                        if (chatId === currentPrivateChatId) continue;
                        
                        const lastReadKey = `lastRead_${chatId}`;
                        const lastRead = localStorage.getItem(lastReadKey);
                        
                        // Get the last message timestamp
                        const messagesQuery = await chatDoc.ref.collection('messages')
                            .orderBy('timestamp', 'desc')
                            .limit(1)
                            .get();
                        
                        if (!messagesQuery.empty) {
                            const lastMessage = messagesQuery.docs[0].data();
                            const lastMessageTime = lastMessage.timestamp?.toMillis?.() || 0;
                            
                            // If never read or new messages since last read
                            if (!lastRead || lastMessageTime > parseInt(lastRead)) {
                                // Don't count if current user sent the message
                                if (lastMessage.senderId !== currentUser.uid) {
                                    totalUnread++;
                                }
                            }
                        }
                    }
                    
                    unreadPrivateCount = totalUnread;
                    updatePrivateNotificationBadge();
                })
                .catch(error => {
                    console.error('Error updating notification count:', error);
                });
        }

        function updatePrivateNotificationBadge() {
            const badge = document.getElementById('privateNotificationBadge');
            if (!badge) return;
            
            if (unreadPrivateCount > 0) {
                badge.textContent = unreadPrivateCount > 99 ? '99+' : unreadPrivateCount;
                badge.style.display = 'flex';
                
                // Add visual indicator to tab
                document.getElementById('privateTab').style.color = 'var(--primary)';
                document.getElementById('privateTab').style.fontWeight = 'bold';
            } else {
                badge.style.display = 'none';
                document.getElementById('privateTab').style.color = '';
                document.getElementById('privateTab').style.fontWeight = '';
            }
            
            // Also update browser tab notification
            updateBrowserTabTitle();
        }

        async function markPrivateChatAsRead(chatId) {
            if (!chatId || !currentUser) return;
            
            // Get the latest message timestamp
            const messagesQuery = await db.collection(`private_chats/${chatId}/messages`)
                .orderBy('timestamp', 'desc')
                .limit(1)
                .get();
            
            if (!messagesQuery.empty) {
                const lastMessage = messagesQuery.docs[0].data();
                const lastMessageTime = lastMessage.timestamp?.toMillis?.() || Date.now();
                
                // Save last read time
                localStorage.setItem(`lastRead_${chatId}`, lastMessageTime.toString());
                
                // Update notification count
                updatePrivateNotificationCount();
            }
        }

        function updateBrowserTabTitle() {
            const totalUnread = unreadPrivateCount;
            
            if (totalUnread > 0) {
                document.title = `(${totalUnread}) ${originalTitle}`;
                
                // Flash tab notification
                if (!notificationInterval && settings.notificationSound) {
                    notificationInterval = setInterval(() => {
                        document.title = document.title === originalTitle 
                            ? `(${totalUnread}) ${originalTitle}` 
                            : originalTitle;
                    }, 1000);
                }
            } else {
                document.title = originalTitle;
                if (notificationInterval) {
                    clearInterval(notificationInterval);
                    notificationInterval = null;
                }
            }
        }

        function handleNewPrivateMessage(chatId, message) {
            // Don't notify if user sent the message
            if (message.senderId === currentUser.uid) return;
            
            // Don't notify if user is viewing this chat
            if (currentPrivateChatId === chatId) return;
            
            // Play sound
            playNotificationSound();
            
            // Show browser notification
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(`New message from ${message.senderName}`, {
                    body: message.text?.substring(0, 100) || 'New message',
                    icon: '/favicon.ico'
                });
            }
        }

        function playNotificationSound() {
            if (!settings.notificationSound) return;
            
            try {
                // Create simple notification beep
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio notification not supported');
            }
        }

        // ==================== CHAT FUNCTIONS ====================
        function joinGroupChat(groupId, groupName) {
            stopAllListeners();
            
            currentGroup = groupId;
            currentGroupType = 'group';
            
            // Update UI
            document.getElementById('chatGroupName').textContent = groupName;
            document.getElementById('groupChatMessages').innerHTML = '<div class="loading"><div class="loading-spinner"></div><div class="loading-text">Loading messages...</div></div>';
            
            showScreen('groupChatScreen');
            loadGroupMessages();
            updateGroupMemberCount();
            
            // Highlight current group
            document.querySelectorAll('.group-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const currentGroupElement = document.querySelector(`.group-item[onclick*="${groupId}"]`);
            if (currentGroupElement) {
                currentGroupElement.classList.add('active');
            }
            
            setTimeout(() => {
                document.getElementById('groupMessageInput').focus();
            }, 100);
        }

        async function loadGroupMessages() {
            if (!currentGroup || currentGroupType !== 'group') return;
            
            const messagesArea = document.getElementById('groupChatMessages');
            
            try {
                messagesListener = db.collection('groups').doc(currentGroup).collection('messages')
                    .orderBy('timestamp', 'asc')
                    .limitToLast(100)
                    .onSnapshot((snapshot) => {
                        const messages = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            timestamp: doc.data().timestamp?.toDate()
                        }));
                        
                        renderGroupMessages(messages);
                        
                        setTimeout(() => {
                            messagesArea.scrollTop = messagesArea.scrollHeight;
                        }, 100);
                        
                    }, (error) => {
                        console.error('Error loading messages:', error);
                        messagesArea.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <div class="empty-state-title">Error Loading Messages</div>
                                <p class="empty-state-description">${error.message}</p>
                            </div>
                        `;
                    });
            } catch (error) {
                console.error('Message listener error:', error);
            }
        }

        function renderGroupMessages(messages) {
            const messagesArea = document.getElementById('groupChatMessages');
            
            if (messages.length === 0) {
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">No Messages Yet</div>
                        <p class="empty-state-description">Send the first message to start the conversation!</p>
                    </div>
                `;
                return;
            }
            
            let lastDate = null;
            messagesArea.innerHTML = '';
            
            messages.forEach((message) => {
                const messageDate = message.timestamp?.toDateString();
                
                // Add date separator if date changed
                if (messageDate !== lastDate) {
                    lastDate = messageDate;
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'date-separator';
                    dateSeparator.innerHTML = `<span>${formatDate(message.timestamp, true)}</span>`;
                    messagesArea.appendChild(dateSeparator);
                }
                
                const isCurrentUser = message.senderId === currentUser?.uid;
                const isSystem = message.type === 'system';
                
                if (isSystem) {
                    const systemMsg = document.createElement('div');
                    systemMsg.className = 'message system';
                    systemMsg.innerHTML = `
                        <div class="message-bubble">${message.text}</div>
                    `;
                    messagesArea.appendChild(systemMsg);
                    return;
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isCurrentUser ? 'sent' : ''}`;
                
                let content = '';
                if (message.type === 'file' && message.file) {
                    const file = message.file;
                    if (file.type.startsWith('image/')) {
                        content = `
                            <div class="message-file">
                                <img src="${file.url}" alt="${file.name}" 
                                     style="max-width: 250px; max-height: 250px; border-radius: 8px; cursor: pointer;" 
                                     onclick="window.open('${file.url}', '_blank')">
                                <div class="file-meta">
                                    <small>${file.name}</small>
                                    <small>${formatFileSize(file.size)}</small>
                                </div>
                            </div>
                        `;
                    } else if (file.type.startsWith('video/')) {
                        content = `
                            <div class="message-file">
                                <video controls style="max-width: 250px; max-height: 250px; border-radius: 8px;">
                                    <source src="${file.url}" type="${file.type}">
                                </video>
                                <div class="file-meta">
                                    <small>${file.name}</small>
                                    <small>${formatFileSize(file.size)}</small>
                                </div>
                            </div>
                        `;
                    } else {
                        content = `
                            <div class="message-file">
                                <div class="file-download" onclick="window.open('${file.url}', '_blank')">
                                    <i class="fas fa-file" style="font-size: 22px; color: var(--primary);"></i>
                                    <div>
                                        <div><strong>${file.name}</strong></div>
                                        <small>${formatFileSize(file.size)}</small>
                                    </div>
                                    <i class="fas fa-download" style="margin-left: auto;"></i>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Handle repost
                if (message.type === 'repost') {
                    content += renderRepostIndicator(message);
                }
                
                // Handle text with @mentions
                if (message.text) {
                    content += `<div class="message-content">${processMentions(escapeHtml(message.text))}</div>`;
                }
                
                // Reactions
                let reactionsHTML = '';
                if (message.reactions && Object.keys(message.reactions).length > 0) {
                    reactionsHTML = `<div class="message-reactions">${renderReactions(message.reactions, message.id, 'group')}</div>`;
                }
                
                const senderName = message.senderName || 'Unknown';
                const avatarContent = senderName.charAt(0).toUpperCase();
                
                messageElement.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-header">
                            <div class="message-sender">
                                ${!isCurrentUser ? senderName : 'You'}
                            </div>
                            <div class="message-time">${formatTime(message.timestamp)}</div>
                        </div>
                        ${content}
                        ${reactionsHTML}
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="addReaction('${message.id}', 'group', '')" title="Love">
                                
                            </button>
                            <button class="message-action-btn" onclick="addReaction('${message.id}', 'group', '')" title="Like">
                                
                            </button>
                            <button class="message-action-btn" onclick="repostMessage('${message.id}', 'group', 'group', '${currentGroup}')" title="Repost">
                                
                            </button>
                            ${!isCurrentUser ? `
                            <button class="message-action-btn" onclick="replyToUser('${senderName}')" title="Reply">
                                @
                            </button>
                            <button class="message-action-btn" onclick="startPrivateChatFromMessage('${message.senderId}', '${senderName}')" title="Private Message">
                                
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                messagesArea.appendChild(messageElement);
            });
        }

        async function sendGroupMessage() {
            const input = document.getElementById('groupMessageInput');
            const text = input.value.trim();
            
            if (!text && selectedFiles.length === 0) return;
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Not authenticated');
                
                const username = userProfile?.username || user.email || 'Anonymous';
                
                let filesData = [];
                if (selectedFiles.length > 0 && currentChatType === 'group') {
                    filesData = await uploadFiles();
                }
                
                // Send message
                const messageData = {
                    senderId: user.uid,
                    senderName: username,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: filesData.length > 0 ? 'file' : 'text'
                };
                
                if (text) {
                    messageData.text = text;
                }
                
                if (filesData.length > 0) {
                    if (filesData.length === 1) {
                        messageData.file = filesData[0];
                    } else {
                        messageData.files = filesData;
                        messageData.text = text || `${filesData.length} files uploaded`;
                    }
                }
                
                await db.collection('groups').doc(currentGroup).collection('messages').add(messageData);
                
                // Update last activity
                await db.collection('groups').doc(currentGroup).update({
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Clear input and file preview
                input.value = '';
                input.style.height = 'auto';
                if (currentChatType === 'group') {
                    selectedFiles = [];
                    document.getElementById('groupFilePreviewArea').style.display = 'none';
                    document.getElementById('groupFilePreviewArea').innerHTML = '';
                    document.getElementById('groupFileInput').value = '';
                }
                
            } catch (error) {
                console.error('Send error:', error);
                showAlert(`Error sending message: ${error.message}`, 'error');
            }
        }

        // ==================== GLOBAL CHAT ====================
        async function initializeGlobalChat() {
            try {
                const globalChatRef = db.collection('global_chat');
                const snapshot = await globalChatRef.limit(1).get();
                
                if (snapshot.empty) {
                    await globalChatRef.add({
                        senderId: 'system',
                        senderName: 'System',
                        text: 'Welcome to Global Chat! Be respectful and follow community guidelines.',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'system'
                    });
                }
            } catch (error) {
                console.log('Global chat initialization:', error);
            }
        }

        function joinGlobalChat() {
            stopAllListeners();
            
            currentGroup = 'global';
            currentGroupType = 'global';
            
            showScreen('globalChatScreen');
            loadGlobalMessages();
            updateGlobalOnlineCount();
            
            setTimeout(() => {
                document.getElementById('globalMessageInput').focus();
            }, 100);
        }

        function loadGlobalMessages() {
            const messagesArea = document.getElementById('globalChatMessages');
            messagesArea.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div class="loading-text">Loading global chat...</div></div>';
            
            try {
                globalChatListener = db.collection('global_chat')
                    .orderBy('timestamp', 'asc')
                    .limitToLast(50)
                    .onSnapshot((snapshot) => {
                        const messages = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            timestamp: doc.data().timestamp?.toDate()
                        }));
                        
                        renderGlobalMessages(messages);
                        
                        setTimeout(() => {
                            messagesArea.scrollTop = messagesArea.scrollHeight;
                        }, 100);
                        
                    }, (error) => {
                        console.error('Error loading global messages:', error);
                        messagesArea.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <div class="empty-state-title">Error Loading Chat</div>
                                <p class="empty-state-description">${error.message}</p>
                                <button class="btn btn-sm btn-secondary" onclick="loadGlobalMessages()">
                                    <i class="fas fa-sync"></i> Try Again
                                </button>
                            </div>
                        `;
                    });
            } catch (error) {
                console.error('Global chat error:', error);
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">Error Loading Chat</div>
                        <p class="empty-state-description">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderGlobalMessages(messages) {
            const messagesArea = document.getElementById('globalChatMessages');
            
            if (messages.length === 0) {
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-title">Global Chat Room</div>
                        <p class="empty-state-description">Welcome to the global chat! Be respectful and follow community guidelines.</p>
                    </div>
                `;
                return;
            }
            
            let lastDate = null;
            messagesArea.innerHTML = '';
            
            messages.forEach((message) => {
                const messageDate = message.timestamp?.toDateString();
                
                if (messageDate !== lastDate) {
                    lastDate = messageDate;
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'date-separator';
                    dateSeparator.innerHTML = `<span>${formatDate(message.timestamp, true)}</span>`;
                    messagesArea.appendChild(dateSeparator);
                }
                
                const isCurrentUser = message.senderId === currentUser?.uid;
                const isSystem = message.type === 'system';
                
                if (isSystem) {
                    const systemMsg = document.createElement('div');
                    systemMsg.className = 'message system';
                    systemMsg.innerHTML = `
                        <div class="message-bubble">${message.text}</div>
                    `;
                    messagesArea.appendChild(systemMsg);
                    return;
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isCurrentUser ? 'sent' : ''}`;
                
                let content = '';
                if (message.type === 'file' && message.file) {
                    const file = message.file;
                    if (file.type.startsWith('image/')) {
                        content = `
                            <div class="message-file">
                                <img src="${file.url}" alt="${file.name}" 
                                     style="max-width: 250px; max-height: 250px; border-radius: 8px; cursor: pointer;" 
                                     onclick="window.open('${file.url}', '_blank')">
                                <div class="file-meta">
                                    <small>${file.name}</small>
                                    <small>${formatFileSize(file.size)}</small>
                                </div>
                            </div>
                        `;
                    } else if (file.type.startsWith('video/')) {
                        content = `
                            <div class="message-file">
                                <video controls style="max-width: 250px; max-height: 250px; border-radius: 8px;">
                                    <source src="${file.url}" type="${file.type}">
                                </video>
                                <div class="file-meta">
                                    <small>${file.name}</small>
                                    <small>${formatFileSize(file.size)}</small>
                                </div>
                            </div>
                        `;
                    } else {
                        content = `
                            <div class="message-file">
                                <div class="file-download" onclick="window.open('${file.url}', '_blank')">
                                    <i class="fas fa-file" style="font-size: 22px; color: var(--primary);"></i>
                                    <div>
                                        <div><strong>${file.name}</strong></div>
                                        <small>${formatFileSize(file.size)}</small>
                                    </div>
                                    <i class="fas fa-download" style="margin-left: auto;"></i>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Handle repost
                if (message.type === 'repost') {
                    content += renderRepostIndicator(message);
                }
                
                // Handle text with @mentions
                if (message.text) {
                    content += `<div class="message-content">${processMentions(escapeHtml(message.text))}</div>`;
                }
                
                // Reactions
                let reactionsHTML = '';
                if (message.reactions && Object.keys(message.reactions).length > 0) {
                    reactionsHTML = `<div class="message-reactions">${renderReactions(message.reactions, message.id, 'global')}</div>`;
                }
                
                const senderName = message.senderName || 'Unknown';
                const avatarContent = senderName.charAt(0).toUpperCase();
                
                messageElement.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-header">
                            <div class="message-sender">
                                ${!isCurrentUser ? senderName : 'You'}
                            </div>
                            <div class="message-time">${formatTime(message.timestamp)}</div>
                        </div>
                        ${content}
                        ${reactionsHTML}
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="addReaction('${message.id}', 'global', '')" title="Love">
                                
                            </button>
                            <button class="message-action-btn" onclick="addReaction('${message.id}', 'global', '')" title="Like">
                                
                            </button>
                            <button class="message-action-btn" onclick="repostMessage('${message.id}', 'global', 'global')" title="Repost">
                                
                            </button>
                            ${!isCurrentUser ? `
                            <button class="message-action-btn" onclick="replyToUser('${senderName}')" title="Reply">
                                @
                            </button>
                            <button class="message-action-btn" onclick="startPrivateChatFromMessage('${message.senderId}', '${senderName}')" title="Private Message">
                                
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                messagesArea.appendChild(messageElement);
            });
        }

        async function sendGlobalMessage() {
            const input = document.getElementById('globalMessageInput');
            const text = input.value.trim();
            
            if (!text && selectedFiles.length === 0) return;
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Please sign in first');
                
                const username = userProfile?.username || user.email || 'Anonymous';
                
                let filesData = [];
                if (selectedFiles.length > 0 && currentChatType === 'global') {
                    filesData = await uploadFiles();
                }
                
                const messageData = {
                    senderId: user.uid,
                    senderName: username,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: filesData.length > 0 ? 'file' : 'text'
                };
                
                if (text) {
                    messageData.text = text;
                }
                
                if (filesData.length > 0) {
                    if (filesData.length === 1) {
                        messageData.file = filesData[0];
                    } else {
                        messageData.files = filesData;
                        messageData.text = text || `${filesData.length} files uploaded`;
                    }
                }
                
                await db.collection('global_chat').add(messageData);
                
                // Clear input and file preview
                input.value = '';
                input.style.height = 'auto';
                if (currentChatType === 'global') {
                    selectedFiles = [];
                    document.getElementById('globalFilePreviewArea').style.display = 'none';
                    document.getElementById('globalFilePreviewArea').innerHTML = '';
                    document.getElementById('globalFileInput').value = '';
                }
                
            } catch (error) {
                console.error('Send error:', error);
                showAlert(`Error sending message: ${error.message}`, 'error');
            }
        }

        function leaveGlobalChat() {
            stopAllListeners();
            
            currentGroup = null;
            currentGroupType = null;
            
            showScreen('dashboardScreen');
        }

        function showGlobalChatInfo() {
            showAlert(
                ' Global Chat Room\n\n Everyone can participate\n Be respectful and follow community guidelines\n No spam or offensive content\n Have fun chatting with people from around the world!',
                'info'
            );
        }

        // ==================== ONLINE USERS ====================
        async function loadOnlineUsers() {
            const onlineUsersContainer = document.getElementById('globalOnlineUsers');
            
            try {
                // Get users who were active in the last 5 minutes
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                
                const usersSnapshot = await db.collection('users')
                    .where('lastSeen', '>', fiveMinutesAgo)
                    .limit(15)
                    .get();
                
                if (usersSnapshot.empty) {
                    onlineUsersContainer.innerHTML = '';
                    document.getElementById('globalUserCount').textContent = '0 users online';
                    return;
                }
                
                const users = usersSnapshot.docs.map(doc => doc.data());
                
                onlineUsersContainer.innerHTML = users.map(user => {
                    const displayName = formatUsername(user.username || 'User');
                    return `
                        <div class="online-user" title="${user.username || 'User'}">
                            <div class="online-user-dot"></div>
                            <span>${displayName}</span>
                        </div>
                    `;
                }).join('');
                
                // Update online count
                document.getElementById('globalUserCount').textContent = `${users.length} users online`;
                
            } catch (error) {
                console.error('Error loading online users:', error);
            }
        }

        function updateGlobalOnlineCount() {
            // Update every 30 seconds
            setInterval(loadOnlineUsers, 30000);
            loadOnlineUsers(); // Initial load
        }

        async function updateGroupMemberCount() {
            if (!currentGroup || currentGroupType !== 'group') return;
            
            try {
                const groupDoc = await db.collection('groups').doc(currentGroup).get();
                if (groupDoc.exists) {
                    const groupData = groupDoc.data();
                    document.getElementById('chatMemberCount').textContent = `${groupData.memberCount || 0} members`;
                    document.getElementById('lastSeen').textContent = formatDate(groupData.lastActivity?.toDate?.());
                }
            } catch (error) {
                console.error('Error updating member count:', error);
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatDate(date, full = false) {
            if (!date) return 'Recently';
            
            const now = new Date();
            const messageDate = date instanceof Date ? date : date.toDate();
            const diffMs = now - messageDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (full) {
                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
                return messageDate.toLocaleDateString();
            }
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return messageDate.toLocaleDateString();
        }

        function formatTime(date) {
            if (!date) return '';
            const messageDate = date instanceof Date ? date : date.toDate();
            return messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function replyToUser(username) {
            const inputId = currentGroupType === 'group' ? 'groupMessageInput' :
                           currentGroupType === 'global' ? 'globalMessageInput' :
                           currentGroupType === 'private' ? 'privateMessageInput' : null;
            
            if (inputId) {
                const input = document.getElementById(inputId);
                input.value = `@${username} ${input.value}`;
                input.focus();
            }
        }

        function handleTyping(type) {
            // This function can be expanded to implement real-time typing indicators
            // For now, it just resizes the textarea
            const input = document.getElementById(`${type}MessageInput`);
            input.style.height = 'auto';
            input.style.height = (input.scrollHeight) + 'px';
        }

        function stopAllListeners() {
            if (messagesListener) {
                messagesListener();
                messagesListener = null;
            }
            if (globalChatListener) {
                globalChatListener();
                globalChatListener = null;
            }
            if (privateChatListener) {
                privateChatListener();
                privateChatListener = null;
            }
            if (typingListener) {
                typingListener();
                typingListener = null;
            }
            if (onlineUsersListener) {
                onlineUsersListener();
                onlineUsersListener = null;
            }
            if (privateChatsListener) {
                privateChatsListener();
                privateChatsListener = null;
            }
        }

        // Update last seen periodically
        setInterval(() => {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }, 30000);

        // Listen for system theme changes
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (settings.theme === 'auto') {
                    if (e.matches) {
                        document.body.classList.add('dark-theme');
                    } else {
                        document.body.classList.remove('dark-theme');
                    }
                }
            });
        }

        // Handle window unload
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                // Update status to offline
                updateUserStatus('offline');
            }
        });

        // Initialize online status on page load
        if (currentUser) {
            updateUserStatus('online');
        }

        // Debug helper
        window.debugPrivateChat = function() {
            console.log('Current Private Chat State:');
            console.log('- Private Chat User:', privateChatUser);
            console.log('- Current Private Chat ID:', currentPrivateChatId);
            console.log('- Current User:', auth.currentUser);
            console.log('- User Profile:', userProfile);
            
            // List all private chats
            db.collection('private_chats').get().then(snapshot => {
                console.log('All Private Chats:');
                snapshot.forEach(doc => {
                    console.log(doc.id, '=>', doc.data());
                });
            });
            
            // List all users
            db.collection('users').get().then(snapshot => {
                console.log('All Users:');
                snapshot.forEach(doc => {
                    console.log(doc.id, '=>', doc.data());
                });
            });
        };
    </script>
</body>
</html>